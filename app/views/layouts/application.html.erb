<!DOCTYPE html>
<html>
  <head>
    <title>Trinidad Fleet Management</title>

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- DHTMLX Gantt CSS - Only load on Gantt pages -->
    <% if content_for?(:gantt_page) %>
      <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <% end %>
    
    <!-- ===============================
         Stylesheets
    ================================ -->
    <%= stylesheet_link_tag "application",
          media: "all",
          "data-turbo-track": "reload" %>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <!-- ===============================
         Import Maps (Turbo + Stimulus)
    ================================ -->
    <%= javascript_importmap_tags %>

    <!-- Favicon -->
    <link rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš—</text></svg>">

    <!-- Theme Support Styles -->
    <style>
      :root {
        --bg-primary: #FFFFFF;
        --bg-secondary: #F8F9FA;
        --bg-card: #FFFFFF;
        --border-color: #E9ECEF;
        --text-primary: #212529;
        --text-secondary: #6C757D;
        --primary-color: #0055A4;
        --secondary-color: #0066CC;
        --success-color: #28A745;
        --warning-color: #FFC107;
        --danger-color: #DC3545;
        --police-color: #BF0A30;
        --ptsc-color: #F1BE48;
        --fire-color: #DC3545;
      }
      
      /* Theme 1: Modern Light (Default) */
      body.theme-1 {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, #E9ECEF 100%);
      }
      
      /* Theme 2: Dark Professional */
      body.theme-2 {
        background: linear-gradient(135deg, #121826 0%, #1A1F2E 100%);
        color: #E2E8F0;
      }
      
      body.theme-2 .card {
        background: #1E2435;
        border-color: #2D3748;
        color: #E2E8F0;
      }
      
      body.theme-2 .text-muted {
        color: #94A3B8 !important;
      }
      
      body.theme-2 .alert-info {
        background-color: #1E293B;
        border-color: #334155;
        color: #E2E8F0;
      }
      
      body.theme-2 .navbar {
        background: #1A1F2E !important;
        border-bottom: 1px solid #2D3748;
      }
      
      body.theme-2 .nav-link {
        color: #E2E8F0 !important;
      }
      
      body.theme-2 .nav-link.active {
        background: #3B82F6 !important;
      }
      
      /* Theme adjustments for DHTMLX Gantt */
      body.theme-2 .gantt_grid_head_cell {
        background-color: #2D3748;
        color: #E2E8F0;
        border-color: #4A5568;
      }
      
      body.theme-2 .gantt_grid_data {
        background-color: #1E2435;
        color: #E2E8F0;
      }
      
      body.theme-2 .gantt_task_line {
        border-color: #4A5568;
      }
      
      /* Theme 3: Trinidad Gradient */
      body.theme-3 {
        background: 
          radial-gradient(circle at 10% 20%, rgba(0, 85, 164, 0.05) 0%, transparent 20%),
          radial-gradient(circle at 90% 80%, rgba(241, 190, 72, 0.05) 0%, transparent 20%),
          #FFFFFF;
      }
      
      body.theme-3 .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(191, 10, 48, 0.1);
      }
      
      body.theme-3 .navbar {
        background: linear-gradient(90deg, #0055A4 0%, #003366 100%) !important;
      }
      
      /* Theme 4: Clean Admin */
      body.theme-4 {
        background: #F5F7FA;
      }
      
      body.theme-4 .card {
        border-top: 4px solid var(--primary-color);
      }
      
      body.theme-4 .navbar {
        background: #2C3E50 !important;
      }
      
      /* Theme 5: Map Centric */
      body.theme-5 {
        background: 
          linear-gradient(45deg, #E8F4FD 25%, transparent 25%),
          linear-gradient(-45deg, #F0F7FF 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #E8F4FD 75%),
          linear-gradient(-45deg, transparent 75%, #F0F7FF 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }
      
      body.theme-5 .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 85, 164, 0.1);
      }
      
      body.theme-5 .navbar {
        background: #1E3A5F !important;
      }
      
      /* Gantt Chart Custom Styling */
      .gantt_task_line {
        border-radius: 4px;
        opacity: 0.9;
      }
      
      .gantt_task_line:hover {
        opacity: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 100;
      }
      
      .gantt_task_content {
        font-size: 12px;
        font-weight: 500;
        color: white;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
      }
      
      .gantt_row.odd {
        background-color: #f8f9fa;
      }
      
      .gantt_row.highlighted {
        background-color: #e7f1ff !important;
      }
      
      .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        display: inline-block;
      }
      
      /* Status specific colors for Gantt bars */
      .gantt_completed {
        background-color: #28a745 !important;
        border-color: #218838 !important;
      }
      
      .gantt_overdue {
        background-color: #dc3545 !important;
        border-color: #c82333 !important;
      }
      
      .gantt_pending {
        background-color: #ffc107 !important;
        border-color: #e0a800 !important;
      }
      
      .gantt_emergency {
        background-color: #fd7e14 !important;
        border-color: #e46c10 !important;
      }
      
      .gantt_routine {
        background-color: #0d6efd !important;
        border-color: #0b5ed7 !important;
      }
      
      .gantt_vehicle {
        background-color: #6c757d !important;
        border-color: #5c636a !important;
      }
    </style>
  </head>

  <body class="bg-light" data-controller="theme">
    <!-- Theme Preview Alert -->
    <div id="themePreviewAlert" class="theme-preview-alert" style="display: none;"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <i class="fas fa-car me-2"></i>Trinidad Fleet Management
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <%= link_to "Vehicle List", vehicles_path,
                    class: "nav-link #{'active' if current_page?(vehicles_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Usage Analytics", vehicle_usages_path,
                    class: "nav-link #{'active' if current_page?(vehicle_usages_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Maintenance Timeline", gantt_path,
                    class: "nav-link #{'active' if current_page?(gantt_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Maintenance Dashboard", maintenance_dashboard_vehicles_path,
                    class: "nav-link #{'active' if current_page?(maintenance_dashboard_vehicles_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Drivers", drivers_path,
                    class: "nav-link #{'active' if current_page?(drivers_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "ðŸŽ¨ Pick Theme", themes_vehicles_path,
                    class: "nav-link #{'active' if current_page?(themes_vehicles_path)}" %>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Flash messages + content -->
    <main class="container-fluid px-4">
      <% if notice %>
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
          <%= notice %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <% if alert %>
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
          <%= alert %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <%= yield %>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DHTMLX Gantt JS - Only load on Gantt pages -->
    <% if content_for?(:gantt_page) %>
      <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <% end %>

    <!-- Theme Controller Script - FIXED VERSION -->
    <script>
      class ThemeController {
        constructor() {
          this.themes = {
            1: 'Modern Light',
            2: 'Dark Professional', 
            3: 'Trinidad Gradient',
            4: 'Clean Admin',
            5: 'Map-Centric'
          };
        }
        
        initialize() {
          const storedTheme = localStorage.getItem('selectedTheme');
          const themeTestMode = localStorage.getItem('themeTestMode');
          
          if (storedTheme && themeTestMode === 'true') {
            this.applyTheme(storedTheme);
            this.showThemePreviewAlert(storedTheme);
          }
          
          this.setupEventListeners();
        }
        
        applyTheme(themeNumber) {
          document.body.classList.remove('theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5');
          document.body.classList.add(`theme-${themeNumber}`);
          this.applyThemeVariables(themeNumber);
        }
        
        applyThemeVariables(themeNumber) {
          const themes = {
            1: {'--bg-primary': '#FFFFFF', '--bg-secondary': '#F8F9FA', '--text-primary': '#212529'},
            2: {'--bg-primary': '#121826', '--bg-secondary': '#1A1F2E', '--text-primary': '#E2E8F0'},
            3: {'--bg-primary': 'linear-gradient(135deg, #FFFFFF 0%, #E8F4FD 100%)', '--bg-secondary': '#FFFFFF', '--text-primary': '#212529'},
            4: {'--bg-primary': '#F5F7FA', '--bg-secondary': '#FFFFFF', '--text-primary': '#2C3E50'},
            5: {'--bg-primary': '#F0F2F5', '--bg-secondary': '#FFFFFF', '--text-primary': '#1A202C'}
          };
          
          const theme = themes[themeNumber] || themes[1];
          Object.entries(theme).forEach(([key, value]) => {
            document.documentElement.style.setProperty(key, value);
          });
        }
        
        showThemePreviewAlert(themeNumber) {
          const alertDiv = document.getElementById('themePreviewAlert');
          const themeName = this.themes[themeNumber] || 'Unknown Theme';
          
          alertDiv.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show mb-0 rounded-0" role="alert">
              <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-palette me-2"></i>
                    <strong>Theme Preview Active:</strong> ${themeName}
                    <span class="ms-2 small">Changes are temporary</span>
                  </div>
                  <div>
                    <button onclick="window.themeController.clearTheme()" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-times me-1"></i> Clear Theme
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          alertDiv.style.display = 'block';
        }
        
        clearTheme() {
          localStorage.removeItem('selectedTheme');
          localStorage.removeItem('themeTestMode');
          document.body.classList.remove('theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5');
          document.getElementById('themePreviewAlert').style.display = 'none';
          this.showToast('Theme preview cleared.', 'success');
        }
        
        setupEventListeners() {
          const urlParams = new URLSearchParams(window.location.search);
          const themeParam = urlParams.get('theme');
          
          if (themeParam && this.themes[themeParam]) {
            localStorage.setItem('selectedTheme', themeParam);
            localStorage.setItem('themeTestMode', 'true');
            this.applyTheme(themeParam);
            this.showThemePreviewAlert(themeParam);
          }
        }
        
        showToast(message, type = 'info') {
          const toastId = 'toast-' + Date.now();
          const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
              <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div>
            </div>
          `;
          
          let container = document.getElementById('toastContainer');
          if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
          }
          
          container.innerHTML += toastHtml;
          const toastElement = document.getElementById(toastId);
          const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
          toast.show();
          
          toastElement.addEventListener('hidden.bs.toast', function () {
            this.remove();
          });
        }
      }
      
      // Initialize theme controller
      document.addEventListener('DOMContentLoaded', () => {
        window.themeController = new ThemeController();
        window.themeController.initialize(); // Initialize after creating instance
      });
      
      // Handle Turbo page changes
      document.addEventListener('turbo:load', () => {
        if (!window.themeController) {
          window.themeController = new ThemeController();
        }
        window.themeController.initialize();
      });
    </script>

    <!-- Load Chart.js only on pages that need it -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on a page that needs Chart.js
        const needsChart = 
          window.location.pathname.includes('analytics') ||
          window.location.pathname.includes('dashboard') ||
          document.querySelector('[data-chart]') ||
          document.querySelector('.chart-container') ||
          document.querySelector('#chart');
        
        if (needsChart) {
          // Wait a bit to see if importmap loaded it
          setTimeout(function() {
            if (!window.Chart) {
              console.log("ðŸ“Š Loading Chart.js for analytics/dashboard...");
              const script = document.createElement('script');
              script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js";
              script.onload = function() {
                console.log("âœ… Chart.js loaded for this page");
                document.dispatchEvent(new CustomEvent('chartjs-loaded'));
              };
              document.head.appendChild(script);
            } else {
              console.log("âœ… Chart.js already available");
            }
          }, 500);
        }
      });
    </script>
  </body>
</html>