<h3 class="mt-4">Maintenance Records</h3>

<% if vehicle.maintenances.any? %>
  <!-- Only show the 'Add Maintenance' button when the vehicle has maintenance records -->
  <%= link_to "Add Maintenance", new_vehicle_maintenance_path(vehicle), class: "btn btn-primary mb-3" %>
<% end %>

<% if vehicle.maintenances.any? %>
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Next Due</th>
          <th>Reminder Sent</th>
          <th>Type</th>
          <th>Status</th>
          <th>Cost</th>
          <th>Notes</th>
          <th>Urgency</th>
          <th>Service Provider</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% vehicle.maintenances.order(date: :desc).each do |m| %>
          <%# Determine row class based on next due date %>
          <% row_class = if m.next_due_date && m.next_due_date < Date.today
                          "table-danger"
                        elsif m.next_due_date && m.next_due_date <= Date.today + 30
                          "table-warning"
                        else
                          ""
                        end %>
          <tr class="<%= row_class %>">
            <td><%= m.date %></td>

            <!-- Next Due Column with Badge and Tooltip -->
            <td>
              <% if m.next_due_date %>
                <%= m.next_due_date %>
                <% if m.next_due_date < Date.today %>
                  <span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= (Date.today - m.next_due_date).to_i %> days overdue">Overdue!</span>
                <% elsif m.next_due_date <= Date.today + 30 %>
                  <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= (m.next_due_date - Date.today).to_i %> days left">Soon</span>
                <% else %>
                  <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top" title="On schedule">OK</span>
                <% end %>
              <% else %>
                <span class="badge bg-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="No due date set">N/A</span>
              <% end %>
            </td>

            <!-- Reminder Sent Column with Badge and Tooltip -->
            <td>
              <% if m.reminder_sent_at %>
                <%= m.reminder_sent_at.strftime("%b %d, %Y %I:%M %p") %>
                <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Reminder sent on <%= m.reminder_sent_at.strftime('%b %d, %Y %I:%M %p') %>">Sent</span>
              <% else %>
                <span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Reminder not sent">Not Sent</span>
              <% end %>
            </td>

            <td><%= m.service_type %></td>
            <td><%= m.status %></td>
            <td><%= m.cost.present? ? number_to_currency(m.cost) : "-" %></td>
            <td><%= m.notes.presence || "-" %></td>
            <td>
              <% if m.urgency_label == "Fast" %>
                <span class="badge bg-success">Fast</span>
              <% else %>
                <span class="badge bg-warning">Soon</span>
              <% end %>
            </td>
            <td><%= m.service_provider&.name || "Not assigned" %></td>

            <!-- Actions Dropdown -->
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu">
                  <li><%= link_to "Show", vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <li><%= link_to "Edit", edit_vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <li><%= link_to "Delete", vehicle_maintenance_path(vehicle, m), method: :delete, data: { confirm: "Are you sure?" }, class: "dropdown-item text-danger" %></li>
                  <li><%= link_to "Mark Completed", mark_maintenance_completed_vehicle_path(vehicle, maintenance_id: m.id), method: :patch, class: "dropdown-item text-success" %></li>
                </ul>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="alert alert-info">
    No maintenance records yet. <%= link_to "Add one now", new_vehicle_maintenance_path(vehicle), class: "alert-link" %>
  </div>
<% end %>
