<div class="container-fluid py-4">
  <!-- Debug Info (remove this section after testing) -->
  <% if Rails.env.development? %>
    <div class="alert alert-info mb-4">
      <h5 class="alert-heading">Debug Information</h5>
      <p><strong>Maintenances found:</strong> <%= @maintenances.count %></p>
      <p><strong>Gantt tasks prepared:</strong> <%= @gantt_tasks&.count || 0 %></p>
      <p><strong>JSON length:</strong> <%= @gantt_json&.length || 0 %></p>
      <% if @gantt_tasks&.any? %>
        <p><strong>Sample task:</strong> <%= @gantt_tasks.first.inspect %></p>
      <% end %>
      <p><strong>Check console for more details</strong></p>
    </div>
  <% end %>

  <!-- Gantt Chart Debug Info -->
  <% if Rails.env.development? %>
    <!-- <div class="alert alert-info mb-4">
      <h5 class="alert-heading">Gantt Chart Debug Info</h5>
      <p><strong>Total Tasks:</strong> <%#= @gantt_tasks&.count || 0 %></p>
      <p><strong>Vehicles:</strong> <%#= @maintenances.map(&:vehicle).uniq.count %></p>
      <p><strong>Date Range Filter:</strong> <%#= params[:date_range] || "90 days" %></p>
      
      <% if @gantt_tasks&.any? %>
        <div class="mt-3">
          <p><strong>Sample Task Data:</strong></p>
          <pre class="bg-light p-2 rounded small"><%#= JSON.pretty_generate(@gantt_tasks.first(2)) %></pre>
        </div>
        
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-secondary" type="button" onclick="document.getElementById('debugData').classList.toggle('d-none')">
            Toggle All Data
          </button>
          <div id="debugData" class="d-none mt-2">
            <pre class="bg-light p-2 rounded small" style="max-height: 300px; overflow: auto;"><%#= JSON.pretty_generate(@gantt_tasks) %></pre>
          </div>
        </div>
      <% end %>
    </div> -->
  <% end %>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Maintenance Schedule Timeline</h1>
      <p class="text-muted mb-0">Visual timeline of all vehicle maintenance tasks</p>
    </div>
    <div>
      <%= link_to "Maintenance Dashboard", maintenance_dashboard_vehicles_path, 
            class: "btn btn-outline-secondary me-2" %>
      <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), 
            class: "btn btn-primary" if Vehicle.any? %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4 card-hover">
    <div class="card-body p-3">
      <%= form_with url: gantt_path, method: :get, local: true, class: "row g-2 align-items-center", id: "ganttFilters" do %>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">View Mode</label>
          <select name="view_mode" id="viewMode" class="form-select form-select-sm">
            <option value="day" <%= 'selected' if params[:view_mode] == 'day' %>>Day View</option>
            <option value="week" <%= 'selected' if params[:view_mode] == 'week' %>>Week View</option>
            <option value="month" <%= params[:view_mode].blank? || params[:view_mode] == 'month' ? 'selected' : '' %>>Month View</option>
            <option value="quarter" <%= 'selected' if params[:view_mode] == 'quarter' %>>Quarter View</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Date Range</label>
          <select name="date_range" id="dateRange" class="form-select form-select-sm">
            <option value="30" <%= 'selected' if params[:date_range] == '30' %>>Next 30 Days</option>
            <option value="90" <%= params[:date_range].blank? || params[:date_range] == '90' ? 'selected' : '' %>>Next 90 Days</option>
            <option value="180" <%= 'selected' if params[:date_range] == '180' %>>Next 6 Months</option>
            <option value="365" <%= 'selected' if params[:date_range] == '365' %>>Next Year</option>
            <option value="custom" <%= 'selected' if params[:date_range] == 'custom' %>>Custom Range</option>
          </select>
        </div>
        
        <div class="col-md-3" id="customDateRange" style="display: <%= params[:date_range] == 'custom' ? 'block' : 'none' %>;">
          <div class="row g-1">
            <div class="col-6">
              <label class="form-label small fw-bold mb-1">Start Date</label>
              <input type="date" name="start_date" class="form-control form-control-sm" 
                     value="<%= params[:start_date] || Date.today.strftime('%Y-%m-%d') %>">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold mb-1">End Date</label>
              <input type="date" name="end_date" class="form-control form-control-sm" 
                     value="<%= params[:end_date] || (Date.today + 90.days).strftime('%Y-%m-%d') %>">
            </div>
          </div>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Service Owner</label>
          <%= select_tag :owner,
                options_for_select(["All Owners"] + @service_owners, params[:owner] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Status</label>
          <%= select_tag :status,
                options_for_select(["All Statuses", "Pending", "Completed"], params[:status] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Vehicle</label>
          <%= select_tag :vehicle_id,
                options_for_select([["All Vehicles", ""]] + @vehicles_for_filter.map { |v| ["#{v.make} #{v.model} (#{v.registration_number})", v.id] }, 
                                  params[:vehicle_id] || ""),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2 w-100">
            <%= submit_tag "Apply Filters", class: "btn btn-primary btn-sm flex-grow-1" %>
            <button type="button" id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset</button>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-tools text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.count %></h3>
              <p class="text-muted mb-0 small">Total Tasks</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
              <i class="bi bi-clock text-warning fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Pending").count %></h3>
              <p class="text-muted mb-0 small">Pending</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3">
              <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.select { |m| m.overdue? }.count %></h3>
              <p class="text-muted mb-0 small">Overdue</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Completed").count %></h3>
              <p class="text-muted mb-0 small">Completed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if @gantt_tasks&.any? %>
    <!-- Timeline Container -->
    <div class="card shadow-sm border-0 card-hover">
      <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Maintenance Timeline</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" id="zoomIn" title="Zoom In">
              <i class="bi bi-zoom-in"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="zoomOut" title="Zoom Out">
              <i class="bi bi-zoom-out"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="fitChart" title="Fit to Screen">
              <i class="bi bi-fullscreen"></i> Fit
            </button>
            <button type="button" class="btn btn-outline-primary" id="exportChart" title="Export as PNG">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </div>
      </div>
      <div class="card-body p-3">
        <div class="timeline-container chart-container" style="position: relative; height: 600px; overflow-x: auto;">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card shadow-sm border-0 mt-4 card-hover">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="me-3 small fw-bold">Legend:</span>
          <div class="d-flex flex-wrap gap-3">
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-success me-2"></span>
              <span class="small">Completed</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-warning me-2"></span>
              <span class="small">Pending</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-danger me-2"></span>
              <span class="small">Overdue</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-info me-2"></span>
              <span class="small">Emergency</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-primary me-2"></span>
              <span class="small">Routine</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Table -->
    <div class="card shadow-sm border-0 mt-4 card-hover">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Maintenance Details</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Vehicle Details</th>
                <th>Task</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Urgency</th>
                <th>Progress</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @processed_maintenances.each do |maintenance| %>
                <tr class="<%= maintenance.overdue? ? 'table-danger' : '' %>">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <% if maintenance.vehicle.image.attached? %>
                          <%= image_tag maintenance.vehicle.image.variant(resize_to_limit: [50, 50]), 
                                class: "rounded-circle vehicle-image-small", 
                                style: "width: 40px; height: 40px; object-fit: cover;" %>
                        <% else %>
                          <div class="vehicle-image-placeholder" style="width: 40px; height: 40px;">
                            <i class="bi bi-car-front text-muted"></i>
                          </div>
                        <% end %>
                      </div>
                      <div>
                        <div class="fw-semibold"><%= maintenance.vehicle.make %> <%= maintenance.vehicle.model %></div>
                        <div class="small text-muted">
                          <i class="bi bi-upc-scan me-1"></i><%= maintenance.vehicle.registration_number %>
                          <% if maintenance.vehicle.license_plate.present? %>
                            <span class="ms-2"><i class="bi bi-tag me-1"></i><%= maintenance.vehicle.license_plate %></span>
                          <% end %>
                        </div>
                        <div class="small">
                          <span class="badge bg-<%= owner_color(maintenance.vehicle.service_owner) %>">
                            <%= maintenance.vehicle.service_owner %>
                          </span>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="fw-medium"><%= maintenance.service_type || maintenance.assignment_type %></div>
                    <% if maintenance.notes.present? %>
                      <div class="small text-muted text-truncate" style="max-width: 150px;" 
                           data-bs-toggle="tooltip" title="<%= maintenance.notes %>">
                        <i class="bi bi-chat-left-text me-1"></i><%= truncate(maintenance.notes, length: 50) %>
                      </div>
                    <% end %>
                  </td>
                  <td><%= maintenance.start_date&.strftime("%b %d, %Y") %></td>
                  <td><%= maintenance.end_date&.strftime("%b %d, %Y") %></td>
                  <td>
                    <span class="badge bg-light text-dark"><%= maintenance.duration_days %> days</span>
                  </td>
                  <td>
                    <%= status_badge(maintenance) %>
                  </td>
                  <td>
                    <span class="badge <%= maintenance.urgency_badge_class %>">
                      <%= maintenance.urgency&.titleize || "Normal" %>
                    </span>
                  </td>
                  <td>
                    <%= progress_bar(maintenance, show_label: true) %>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-primary", 
                            title: "View Details",
                            data: { turbo_frame: "_top" } do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= link_to edit_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-secondary", 
                            title: "Edit",
                            data: { turbo_frame: "_top" } do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <% if maintenance.pending? %>
                        <%= button_to mark_completed_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                              method: :patch,
                              class: "btn btn-outline-success",
                              title: "Mark Completed",
                              form: { class: "d-inline" },
                              data: { turbo_confirm: "Mark this maintenance as completed?" } do %>
                          <i class="bi bi-check-circle"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <!-- No data message -->
    <div class="card shadow-sm border-0 card-hover">
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="mb-3">No maintenance scheduled</h4>
        <p class="text-muted mb-4">No maintenance records found for the selected filters and date range.</p>
        <p class="small text-info">
          <% if @maintenances.count > 0 %>
            Found <%= @maintenances.count %> maintenance records, but they might not have start and end dates set.
            <%= link_to "Add dates to maintenances", maintenance_dashboard_vehicles_path, class: "alert-link" %>
          <% else %>
            No maintenance records found in the system at all.
          <% end %>
        </p>
        <div class="d-flex justify-content-center gap-3">
          <%= link_to "View All Vehicles", vehicles_path, class: "btn btn-primary" %>
          <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), 
                class: "btn btn-success" if Vehicle.any? %>
          <button type="button" onclick="document.getElementById('ganttFilters').scrollIntoView({behavior: 'smooth'});" 
                  class="btn btn-outline-secondary">
            Adjust Filters
          </button>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
  /* GANTT-SPECIFIC STYLES ONLY */
  .maintenance-timeline-bar {
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 11px;
    color: white;
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }

  .maintenance-timeline-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }

  /* Custom scrollbar for timeline - Gantt specific */
  .timeline-container::-webkit-scrollbar,
  .chart-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .timeline-container::-webkit-scrollbar-track,
  .chart-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  .timeline-container::-webkit-scrollbar-thumb,
  .chart-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  .timeline-container::-webkit-scrollbar-thumb:hover,
  .chart-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .chart-container {
    min-width: 100%;
  }

  /* Simple timeline fallback styles - Gantt specific */
  .simple-timeline {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    padding: 20px;
  }

  .vehicle-timeline {
    border-left: 3px solid #6c757d;
    padding-left: 15px;
    margin-left: 10px;
    margin-bottom: 20px;
  }

  .timeline-item {
    border-left: 4px solid #0d6efd;
    padding-left: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .timeline-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
</style>

<!-- Load Chart.js with Date Adapter -->
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Show/hide custom date range
  const dateRangeSelect = document.getElementById('dateRange');
  const customDateRange = document.getElementById('customDateRange');
  
  if (dateRangeSelect) {
    dateRangeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customDateRange.style.display = 'block';
      } else {
        customDateRange.style.display = 'none';
      }
    });
    
    // Trigger change on page load if custom is selected
    if (dateRangeSelect.value === 'custom') {
      customDateRange.style.display = 'block';
    }
  }
  
  // Reset filters
  const resetButton = document.getElementById('resetFilters');
  if (resetButton) {
    resetButton.addEventListener('click', function() {
      window.location.href = '<%= gantt_path %>';
    });
  }
  
  <% if @gantt_tasks&.any? %>
    // Create the chart
    createTimelineChart();
  <% end %>
  
  function createTimelineChart() {
    try {
      // Parse the data
      const tasks = JSON.parse('<%= raw escape_javascript(@gantt_json) %>');
      
      // Group data by vehicle
      const vehicles = {};
      tasks.forEach(task => {
        if (task.type === 'vehicle') {
          vehicles[task.id] = {
            ...task,
            maintenances: []
          };
        }
      });
      
      // Add maintenances to vehicles
      tasks.forEach(task => {
        if (task.type === 'maintenance' && vehicles[task.parent]) {
          vehicles[task.parent].maintenances.push(task);
        }
      });
      
      // Prepare chart data
      const labels = [];
      const datasets = [];
      
      Object.values(vehicles).forEach((vehicle, vehicleIndex) => {
        if (!vehicle.maintenances || vehicle.maintenances.length === 0) {
          return;
        }
        
        labels.push(vehicle.name);
        
        // Add each maintenance
        vehicle.maintenances.forEach(maintenance => {
          // Convert timestamps to Date objects
          const startDate = new Date(parseInt(maintenance.start));
          const endDate = new Date(parseInt(maintenance.end));
          
          if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            return;
          }
          
          const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
          
          datasets.push({
            label: maintenance.name,
            data: [{
              x: [startDate, endDate],
              y: vehicleIndex,
              duration: duration,
              details: maintenance.details || {}
            }],
            backgroundColor: maintenance.color || 'rgba(108, 117, 125, 0.6)',
            borderColor: maintenance.color ? maintenance.color.replace('0.8', '1') : 'rgba(108, 117, 125, 1)',
            borderWidth: 2,
            borderRadius: 4,
            barPercentage: 0.6,
            categoryPercentage: 0.6
          });
        });
      });
      
      if (labels.length === 0) {
        showChartError('No vehicles with maintenance tasks found.');
        return;
      }
      
      // Create chart
      const ctx = document.getElementById('timelineChart');
      if (!ctx) {
        showChartError('Chart canvas not found');
        return;
      }
      
      // Calculate date range
      const allDates = datasets.flatMap(d => d.data.flatMap(d => d.x));
      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...allDates));
      
      // Add padding
      minDate.setDate(minDate.getDate() - 7);
      maxDate.setDate(maxDate.getDate() + 7);
      
      // Create the chart - SIMPLIFIED VERSION
      const chart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].dataset.label;
                },
                label: function(context) {
                  const data = context.raw;
                  const start = formatDate(data.x[0]);
                  const end = formatDate(data.x[1]);
                  const duration = data.duration || '?';
                  const status = data.details?.status || 'Unknown';
                  const urgency = data.details?.urgency || 'Normal';
                  const cost = data.details?.cost || 0;
                  
                  return [
                    `Start: ${start}`,
                    `End: ${end}`,
                    `Duration: ${duration} days`,
                    `Status: ${status}`,
                    `Urgency: ${urgency}`,
                    cost > 0 ? `Cost: R${parseFloat(cost).toFixed(2)}` : null
                  ].filter(Boolean);
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day',
                displayFormats: {
                  day: 'dd/MM'
                }
              },
              min: minDate,
              max: maxDate,
              title: {
                display: true,
                text: 'Timeline'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value, index) {
                  return labels[index] || '';
                }
              },
              title: {
                display: true,
                text: 'Vehicles'
              }
            }
          }
        }
      });
      
      // Setup controls
      setupChartControls(chart);
      
    } catch (error) {
      // Try alternative approach without date adapter
      createSimpleChartWithoutDateAdapter();
    }
  }
  
  // Alternative: Create chart without date adapter
  function createSimpleChartWithoutDateAdapter() {
    try {
      const tasks = JSON.parse('<%= raw escape_javascript(@gantt_json) %>');
      
      // Group data
      const vehicles = {};
      tasks.forEach(task => {
        if (task.type === 'vehicle') {
          vehicles[task.id] = {
            ...task,
            maintenances: []
          };
        }
      });
      
      tasks.forEach(task => {
        if (task.type === 'maintenance' && vehicles[task.parent]) {
          vehicles[task.parent].maintenances.push(task);
        }
      });
      
      // Create HTML table as fallback
      const container = document.querySelector('.chart-container');
      if (!container) return;
      
      let html = '<div class="simple-timeline p-3">';
      html += '<h5 class="mb-4">Maintenance Timeline</h5>';
      
      Object.values(vehicles).forEach(vehicle => {
        if (!vehicle.maintenances || vehicle.maintenances.length === 0) return;
        
        html += `<div class="vehicle-timeline mb-4">`;
        html += `<h6 class="border-bottom pb-2">${vehicle.name}</h6>`;
        html += '<div class="timeline-items">';
        
        vehicle.maintenances.forEach(maintenance => {
          const start = new Date(parseInt(maintenance.start));
          const end = new Date(parseInt(maintenance.end));
          const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
          
          const startStr = formatDateDDMMYYYY(start);
          const endStr = formatDateDDMMYYYY(end);
          
          // Determine status class
          let statusClass = 'bg-secondary';
          if (maintenance.details?.status === 'Completed') statusClass = 'status-completed';
          else if (maintenance.details?.urgency === 'emergency') statusClass = 'status-overdue';
          else if (maintenance.details?.urgency === 'scheduled') statusClass = 'status-active';
          else statusClass = 'status-pending';
          
          html += `
            <div class="timeline-item mb-3 p-3 rounded ${statusClass} maintenance-timeline-bar">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong class="d-block mb-1">${maintenance.name}</strong>
                  <div class="small text-white-80">
                    <i class="bi bi-calendar me-1"></i>${startStr} â†’ ${endStr}
                  </div>
                </div>
                <span class="badge bg-light text-dark">${duration} days</span>
              </div>
              <div class="small text-white-80 mt-2">
                <span class="me-3"><i class="bi bi-info-circle me-1"></i>Status: ${maintenance.details?.status || 'Unknown'}</span>
                <span><i class="bi bi-clock me-1"></i>Urgency: ${maintenance.details?.urgency || 'Normal'}</span>
              </div>
            </div>`;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      container.innerHTML = html;
      
    } catch (error) {
      showChartError(`Failed to create chart: ${error.message}`);
    }
  }
  
  // Helper functions
  function formatDate(date) {
    const d = new Date(date);
    if (isNaN(d.getTime())) return 'Invalid Date';
    
    const day = d.getDate().toString().padStart(2, '0');
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }
  
  function formatDateDDMMYYYY(date) {
    const d = new Date(date);
    if (isNaN(d.getTime())) return 'Invalid Date';
    
    const day = d.getDate().toString().padStart(2, '0');
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }
  
  function setupChartControls(chart) {
    // Zoom controls
    document.getElementById('zoomIn')?.addEventListener('click', function() {
      try {
        const xScale = chart.scales.x;
        const range = xScale.max - xScale.min;
        chart.options.scales.x.min = new Date(xScale.min.getTime() + range * 0.1);
        chart.options.scales.x.max = new Date(xScale.max.getTime() - range * 0.1);
        chart.update('none');
      } catch (error) {
        console.error('Zoom in error:', error);
      }
    });
    
    document.getElementById('zoomOut')?.addEventListener('click', function() {
      try {
        const xScale = chart.scales.x;
        const range = xScale.max - xScale.min;
        chart.options.scales.x.min = new Date(xScale.min.getTime() - range * 0.1);
        chart.options.scales.x.max = new Date(xScale.max.getTime() + range * 0.1);
        chart.update('none');
      } catch (error) {
        console.error('Zoom out error:', error);
      }
    });
    
    document.getElementById('fitChart')?.addEventListener('click', function() {
      try {
        const allDates = chart.data.datasets.flatMap(d => d.data.flatMap(d => d.x));
        if (allDates.length > 0) {
          const minDate = new Date(Math.min(...allDates));
          const maxDate = new Date(Math.max(...allDates));
          minDate.setDate(minDate.getDate() - 7);
          maxDate.setDate(maxDate.getDate() + 7);
          
          chart.options.scales.x.min = minDate;
          chart.options.scales.x.max = maxDate;
          chart.update('none');
        }
      } catch (error) {
        console.error('Fit chart error:', error);
      }
    });
    
    document.getElementById('exportChart')?.addEventListener('click', function() {
      try {
        const link = document.createElement('a');
        link.download = 'maintenance-timeline.png';
        link.href = chart.toBase64Image();
        link.click();
      } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting chart: ' + error.message);
      }
    });
  }
  
  function showChartError(message) {
    console.error('Chart error:', message);
    const container = document.querySelector('.chart-container');
    if (container) {
      container.innerHTML = `
        <div class="alert alert-danger m-3">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>Error Loading Timeline</h5>
          <p>${message}</p>
          <p class="small">Check the browser console for debugging information.</p>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Reload Page
          </button>
        </div>`;
    }
  }
});
</script