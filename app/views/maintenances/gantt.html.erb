<%# app/views/maintenances/gantt.html.erb %>
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Maintenance Schedule Gantt Chart</h1>
      <p class="text-muted mb-0">Visual timeline of all vehicle maintenance tasks</p>
    </div>
    <div>
      <%= link_to "Maintenance Dashboard", maintenance_dashboard_vehicles_path, class: "btn btn-outline-secondary me-2" %>
      <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), class: "btn btn-primary" if Vehicle.any? %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body p-3">
      <%= form_with url: gantt_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">View Mode</label>
          <select name="view_mode" id="viewMode" class="form-select form-select-sm">
            <option value="Day">Day View</option>
            <option value="Week">Week View</option>
            <option value="Month" selected>Month View</option>
            <option value="Quarter">Quarter View</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Date Range</label>
          <select name="date_range" id="dateRange" class="form-select form-select-sm">
            <option value="30">Next 30 Days</option>
            <option value="90" selected>Next 90 Days</option>
            <option value="180">Next 6 Months</option>
            <option value="365">Next Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        
        <div class="col-md-2" id="customDateRange" style="display: none;">
          <div class="row g-1">
            <div class="col-6">
              <input type="date" name="start_date" class="form-control form-control-sm" value="<%= Date.today.strftime('%Y-%m-%d') %>">
            </div>
            <div class="col-6">
              <input type="date" name="end_date" class="form-control form-control-sm" value="<%= (Date.today + 90.days).strftime('%Y-%m-%d') %>">
            </div>
          </div>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Service Owner</label>
          <%= select_tag :owner,
                options_for_select(["All Owners"] + @service_owners, params[:owner] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Status</label>
          <%= select_tag :status,
                options_for_select(["All Statuses", "Pending", "Completed", "Overdue"], params[:status] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Vehicle</label>
          <%= select_tag :vehicle_id,
                options_for_select([["All Vehicles", ""]] + @vehicles.map { |v| ["#{v.make} #{v.model} (#{v.registration_number})", v.id] }, 
                                  params[:vehicle_id] || ""),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2 w-100">
            <%= submit_tag "Apply Filters", class: "btn btn-primary btn-sm flex-grow-1" %>
            <button type="button" id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset</button>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-tools text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.count %></h3>
              <p class="text-muted mb-0 small">Total Tasks</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
              <i class="bi bi-clock text-warning fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Pending").count %></h3>
              <p class="text-muted mb-0 small">Pending</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3">
              <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.select { |m| m.overdue? }.count %></h3>
              <p class="text-muted mb-0 small">Overdue</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Completed").count %></h3>
              <p class="text-muted mb-0 small">Completed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gantt Chart Container -->
  <% if @processed_maintenances.any? %>
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Maintenance Timeline</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" id="zoomIn">
              <i class="bi bi-zoom-in"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="zoomOut">
              <i class="bi bi-zoom-out"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="fitChart">
              <i class="bi bi-fullscreen"></i> Fit to Screen
            </button>
            <button type="button" class="btn btn-outline-primary" id="exportChart">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="ganttChart" style="height: 700px; overflow-x: auto;"></div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="me-3 small fw-bold">Legend:</span>
          <div class="d-flex flex-wrap gap-3">
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-success me-2"></span>
              <span class="small">Completed</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-warning me-2"></span>
              <span class="small">Pending</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-danger me-2"></span>
              <span class="small">Overdue</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-info me-2"></span>
              <span class="small">Emergency</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-primary me-2"></span>
              <span class="small">Routine</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Table -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Maintenance Details</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Vehicle Details</th>
                <th>Task</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Urgency</th>
                <th>Progress</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @processed_maintenances.each do |maintenance| %>
                <tr class="<%= maintenance.overdue? ? 'table-danger' : '' %>">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <% if maintenance.vehicle.image.attached? %>
                          <%= image_tag maintenance.vehicle.image.variant(resize_to_limit: [50, 50]), 
                                class: "rounded-circle", 
                                style: "width: 40px; height: 40px; object-fit: cover;" %>
                        <% else %>
                          <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                               style="width: 40px; height: 40px;">
                            <i class="bi bi-car-front text-muted"></i>
                          </div>
                        <% end %>
                      </div>
                      <div>
                        <div class="fw-semibold"><%= maintenance.vehicle.make %> <%= maintenance.vehicle.model %></div>
                        <div class="small text-muted">
                          <i class="bi bi-upc-scan me-1"></i><%= maintenance.vehicle.registration_number %>
                          <% if maintenance.vehicle.license_plate.present? %>
                            <span class="ms-2"><i class="bi bi-tag me-1"></i><%= maintenance.vehicle.license_plate %></span>
                          <% end %>
                        </div>
                        <div class="small">
                          <span class="badge bg-<%= owner_color(maintenance.vehicle.service_owner) %>">
                            <%= maintenance.vehicle.service_owner %>
                          </span>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="fw-medium"><%= maintenance.service_type || maintenance.assignment_type %></div>
                    <% if maintenance.notes.present? %>
                      <div class="small text-muted text-truncate" style="max-width: 150px;" title="<%= maintenance.notes %>">
                        <i class="bi bi-chat-left-text me-1"></i><%= truncate(maintenance.notes, length: 50) %>
                      </div>
                    <% end %>
                  </td>
                  <td><%= maintenance.start_date&.strftime("%b %d, %Y") %></td>
                  <td><%= maintenance.end_date&.strftime("%b %d, %Y") %></td>
                  <td>
                    <% duration = (maintenance.end_date - maintenance.start_date).to_i + 1 %>
                    <span class="badge bg-light text-dark"><%= duration %> days</span>
                  </td>
                  <td>
                    <span class="badge <%= maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>">
                      <%= maintenance.status %>
                      <% if maintenance.overdue? %>
                        <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                      <% end %>
                    </span>
                  </td>
                  <td>
                    <span class="badge <%= urgency_badge_class(maintenance.urgency) %>">
                      <%= maintenance.urgency&.titleize || "Normal" %>
                    </span>
                  </td>
                  <td>
                    <div class="progress" style="height: 6px; width: 80px;">
                      <div class="progress-bar <%= maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>" 
                           style="width: <%= maintenance.status == 'Completed' ? '100' : '50' %>%">
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-primary", 
                            title: "View Details" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= link_to edit_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-secondary", 
                            title: "Edit" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <% if maintenance.pending? %>
                        <%= button_to mark_completed_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                              method: :patch,
                              class: "btn btn-outline-success",
                              title: "Mark Completed",
                              form: { class: "d-inline" } do %>
                          <i class="bi bi-check-circle"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <div class="card shadow-sm border-0">
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="mb-3">No maintenance scheduled</h4>
        <p class="text-muted mb-4">No maintenance records found for the selected filters and date range.</p>
        <div class="d-flex justify-content-center gap-3">
          <%= link_to "View All Vehicles", vehicles_path, class: "btn btn-primary" %>
          <%= link_to "Adjust Filters", "javascript:void(0)", onclick: "document.querySelector('form').scrollIntoView({behavior: 'smooth'});", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Gantt Chart Styles -->
<style>
  .gantt-container {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  .gantt .bar {
    rx: 3px;
    ry: 3px;
  }
  
  .gantt .bar-progress {
    rx: 3px;
    ry: 3px;
  }
  
  .gantt .bar-label {
    font-size: 11px;
    font-weight: 500;
    fill: white;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
  }
  
  .legend-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .table th {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    border-bottom-width: 2px;
  }
  
  .progress {
    background-color: #e9ecef;
  }
  
  /* Custom scrollbar for gantt */
  #ganttChart::-webkit-scrollbar {
    height: 8px;
  }
  
  #ganttChart::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #ganttChart::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #ganttChart::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Hierarchical row styles */
  .gantt .grid-row {
    border-bottom: 1px solid #e9ecef;
  }
  
  .gantt .grid-row-header {
    padding: 10px 15px;
    background-color: #f8f9fa;
    border-right: 1px solid #dee2e6;
  }
  
  .row-content {
    display: flex;
    align-items: center;
    padding: 5px 0;
  }
  
  /* Vehicle rows - bold and prominent */
  .gantt .grid-row.vehicle-row {
    background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #0d6efd;
    font-weight: 700;
  }
  
  /* Folder rows - indented with icons */
  .gantt .grid-row.folder-row {
    background-color: #fff;
    border-left: 3px solid #ffc107;
    padding-left: 20px !important;
  }
  
  /* Maintenance rows - further indented */
  .gantt .grid-row.maintenance-row {
    background-color: #f8f9fa;
    border-left: 2px solid #6c757d;
    padding-left: 40px !important;
    font-size: 0.9em;
  }
  
  /* Color coding for urgency */
  .gantt .bar.folder-emergency { background-color: #dc3545 !important; }
  .gantt .bar.folder-scheduled { background-color: #0dcaf0 !important; }
  .gantt .bar.folder-upcoming { background-color: #20c997 !important; }
  .gantt .bar.folder-completed { background-color: #6c757d !important; }
  
  /* Time-based folder colors */
  .gantt .bar.folder-this_week { background-color: #dc3545 !important; }
  .gantt .bar.folder-next_week { background-color: #fd7e14 !important; }
  .gantt .bar.folder-this_month { background-color: #20c997 !important; }
  .gantt .bar.folder-future { background-color: #6c757d !important; }
  
  /* Status-based maintenance colors */
  .gantt .bar.status-completed { background-color: #28a745 !important; }
  .gantt .bar.status-pending { background-color: #ffc107 !important; }
  .gantt .bar.status-overdue { background-color: #dc3545 !important; }
  
  /* Popup styling */
  .gantt-popup {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #dee2e6;
  }
  
  .gantt .bar:hover {
    filter: brightness(1.1);
    cursor: pointer;
  }
</style>

<!-- Gantt Chart JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show/hide custom date range
    const dateRangeSelect = document.getElementById('dateRange');
    const customDateRange = document.getElementById('customDateRange');
    
    dateRangeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customDateRange.style.display = 'block';
      } else {
        customDateRange.style.display = 'none';
      }
    });
    
    // Reset filters
    document.getElementById('resetFilters').addEventListener('click', function() {
      window.location.href = '<%= gantt_path %>';
    });
    
    <% if @processed_maintenances.any? %>
      // Helper function to determine time-based folder
      function getTimeBasedFolder(startDate) {
        const today = new Date();
        const start = new Date(startDate);
        const diffTime = start - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 7) return 'this_week';
        if (diffDays <= 14) return 'next_week';
        if (diffDays <= 30) return 'this_month';
        return 'future';
      }
      
      // Helper function to determine folder urgency
      function getFolderUrgency(maintenance) {
        if (maintenance.overdue) return 'emergency';
        if (maintenance.status === 'Completed') return 'completed';
        if (maintenance.urgency === 'scheduled') return 'scheduled';
        return 'upcoming';
      }
      
      // Create hierarchical structure
      const tasks = [];
      let taskIdCounter = 1;
      
      // Group maintenance by vehicle and time period
      <%
        vehicle_groups = @processed_maintenances.group_by { |m| m.vehicle.id }
        vehicle_groups.each do |vehicle_id, vehicle_maintenances|
          vehicle = vehicle_maintenances.first.vehicle
          
          # Group by time periods
          time_groups = vehicle_maintenances.group_by { |m| 
            start_date = m.start_date
            diff_days = (start_date - Date.today).to_i
            
            if diff_days <= 7
              "This Week"
            elsif diff_days <= 14
              "Next Week"
            elsif diff_days <= 30
              "This Month"
            else
              "Future"
            end
          }
      %>
        
        // Add vehicle row
        const vehicleTaskId = `vehicle-${taskIdCounter++}`;
        tasks.push({
          id: vehicleTaskId,
          name: '<%= j vehicle.make %> <%= j vehicle.model %>',
          type: 'vehicle',
          details: {
            service_owner: '<%= j vehicle.service_owner %>',
            current_driver: '<%= j (vehicle.current_driver || "No driver") %>',
            registration: '<%= j vehicle.registration_number %>',
            license_plate: '<%= j (vehicle.license_plate || "") %>'
          },
          color: '#0d6efd',
          // Vehicle spans entire timeframe
          start: '<%= (vehicle_maintenances.map(&:start_date).min || Date.today).strftime("%Y-%m-%d") %>',
          end: '<%= (vehicle_maintenances.map(&:end_date).max || Date.today).strftime("%Y-%m-%d") %>',
          progress: 0,
          dependencies: '',
          custom_class: 'vehicle-row'
        });
        
        <% time_groups.each do |time_period, period_maintenances| %>
          // Add folder row for each time period
          const folderTaskId = `folder-${taskIdCounter++}`;
          const folderStartDate = '<%= (period_maintenances.map(&:start_date).min || Date.today).strftime("%Y-%m-%d") %>';
          const folderEndDate = '<%= (period_maintenances.map(&:end_date).max || Date.today).strftime("%Y-%m-%d") %>';
          
          tasks.push({
            id: folderTaskId,
            name: '<%= j time_period %>',
            type: 'folder',
            details: {
              count: <%= period_maintenances.count %>,
              time_period: '<%= j time_period %>'
            },
            color: '#ffc107',
            start: folderStartDate,
            end: folderEndDate,
            progress: 0,
            dependencies: vehicleTaskId,
            custom_class: 'folder-row folder-<%= j time_period.downcase.gsub(" ", "_") %>'
          });
          
          <% period_maintenances.each do |maintenance| %>
            // Add maintenance rows
            tasks.push({
              id: '<%= maintenance.id %>',
              name: '<%= j (maintenance.service_type || maintenance.assignment_type || "Maintenance") %>',
              type: 'maintenance',
              details: {
                technician: '<%= j (maintenance.service_provider&.name || "Not assigned") %>',
                status: '<%= j maintenance.status %>',
                cost: <%= maintenance.cost || 0 %>,
                urgency: '<%= j (maintenance.urgency || "normal") %>',
                notes: '<%= j (maintenance.notes || "") %>',
                mileage: '<%= maintenance.mileage || "N/A" %>'
              },
              color: '<%= 
                if maintenance.overdue?
                  "#dc3545"
                elsif maintenance.status == "Completed"
                  "#28a745"
                elsif maintenance.urgency == "emergency"
                  "#fd7e14"
                elsif maintenance.urgency == "scheduled"
                  "#0dcaf0"
                else
                  "#0d6efd"
                end
              %>',
              start: '<%= maintenance.start_date.strftime("%Y-%m-%d") %>',
              end: '<%= maintenance.end_date.strftime("%Y-%m-%d") %>',
              progress: <%= maintenance.status == "Completed" ? 100 : 50 %>,
              dependencies: folderTaskId,
              custom_class: 'maintenance-row status-<%= j maintenance.status.downcase %> ' +
                           '<%= maintenance.overdue? ? "status-overdue" : "" %> ' +
                           'folder-<%= j get_time_based_folder(maintenance.start_date) %>'
            });
          <% end %>
        <% end %>
      <% end %>
      
      // Initialize Gantt chart with custom row headers
      const gantt = new Gantt("#ganttChart", tasks, {
        header_height: 50,
        column_width: 30,
        step: 24,
        view_modes: ['Quarter', 'Month', 'Week', 'Day'],
        bar_height: 22,
        bar_corner_radius: 3,
        arrow_curve: 5,
        padding: 16,
        view_mode: 'Month',
        date_format: 'YYYY-MM-DD',
        language: 'en',
        custom_row_html: function(task) {
          if (task.type === 'vehicle') {
            return `
              <div class="row-content vehicle-row">
                <div class="d-flex align-items-center w-100">
                  <div class="me-2">
                    <i class="bi bi-car-front-fill" style="color: ${task.color}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-bold">${task.name}</div>
                    <div class="small text-muted">
                      ${task.details.service_owner} • Driver: ${task.details.current_driver}
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-primary">${task.details.registration}</span>
                    ${task.details.license_plate ? 
                      `<span class="badge bg-secondary ms-1">${task.details.license_plate}</span>` : ''}
                  </div>
                </div>
              </div>
            `;
          } else if (task.type === 'folder') {
            const timeClass = task.custom_class.includes('this_week') ? 'danger' :
                            task.custom_class.includes('next_week') ? 'warning' :
                            task.custom_class.includes('this_month') ? 'success' : 'secondary';
            
            return `
              <div class="row-content folder-row">
                <div class="d-flex align-items-center w-100">
                  <div class="me-2">
                    <i class="bi bi-folder-fill text-${timeClass}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div>${task.name}</div>
                    <div class="small text-muted">
                      ${task.details.count} maintenance tasks
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-${timeClass}">${task.details.time_period}</span>
                  </div>
                </div>
              </div>
            `;
          } else if (task.type === 'maintenance') {
            const statusClass = task.details.status === 'Completed' ? 'success' : 
                              task.custom_class.includes('overdue') ? 'danger' : 'warning';
            const urgencyClass = task.details.urgency === 'emergency' ? 'danger' :
                               task.details.urgency === 'scheduled' ? 'info' : 'primary';
            
            return `
              <div class="row-content maintenance-row">
                <div class="d-flex align-items-center w-100">
                  <div class="me-2">
                    <i class="bi bi-tools text-${statusClass}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div>${task.name}</div>
                    <div class="small text-muted">
                      ${task.details.technician} • ${task.details.status} • 
                      ${task.details.cost > 0 ? '$' + task.details.cost : 'No cost'}
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-${urgencyClass} me-1">
                      ${task.details.urgency.charAt(0).toUpperCase() + task.details.urgency.slice(1)}
                    </span>
                    <span class="badge bg-${statusClass}">
                      ${task.details.status}
                    </span>
                  </div>
                </div>
              </div>
            `;
          }
          return `<div class="row-content">${task.name}</div>`;
        },
        custom_popup_html: function(task) {
          if (task.type === 'vehicle') {
            return `
              <div class="gantt-popup p-3" style="min-width: 300px;">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div>
                    <h6 class="mb-1 fw-bold">
                      <i class="bi bi-car-front-fill me-1"></i>${task.name}
                    </h6>
                    <div class="small text-muted">
                      Service Owner: ${task.details.service_owner}
                    </div>
                  </div>
                  <span class="badge bg-primary">Vehicle</span>
                </div>
                
                <div class="mb-3">
                  <div class="small text-muted">Details</div>
                  <div class="fw-semibold">
                    <div><i class="bi bi-upc-scan me-1"></i>${task.details.registration}</div>
                    ${task.details.license_plate ? 
                      `<div><i class="bi bi-tag me-1"></i>${task.details.license_plate}</div>` : ''}
                    <div><i class="bi bi-person me-1"></i>${task.details.current_driver}</div>
                  </div>
                </div>
                
                <div class="mt-3 pt-3 border-top">
                  <a href="/vehicles/${task.id.split('-')[1]}" 
                     class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-eye me-1"></i> View Vehicle Details
                  </a>
                </div>
              </div>
            `;
          } else if (task.type === 'folder') {
            return `
              <div class="gantt-popup p-3" style="min-width: 300px;">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div>
                    <h6 class="mb-1 fw-bold">
                      <i class="bi bi-folder-fill me-1"></i>${task.name}
                    </h6>
                    <div class="small text-muted">
                      ${task.details.time_period} Tasks
                    </div>
                  </div>
                  <span class="badge bg-secondary">Folder</span>
                </div>
                
                <div class="mb-3">
                  <div class="small text-muted">Summary</div>
                  <div class="fw-semibold">
                    <div><i class="bi bi-list-task me-1"></i>${task.details.count} tasks in this period</div>
                    <div><i class="bi bi-calendar-range me-1"></i>${task.start} to ${task.end}</div>
                  </div>
                </div>
              </div>
            `;
          } else if (task.type === 'maintenance') {
            const statusClass = task.details.status === 'Completed' ? 'success' : 
                              task.custom_class.includes('overdue') ? 'danger' : 'warning';
            const urgencyClass = task.details.urgency === 'emergency' ? 'danger' :
                               task.details.urgency === 'scheduled' ? 'info' : 'primary';
            
            return `
              <div class="gantt-popup p-3" style="min-width: 350px;">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div>
                    <h6 class="mb-1 fw-bold">${task.name}</h6>
                    <div class="small text-muted">
                      <i class="bi bi-car-front me-1"></i>${task.custom_class.includes('vehicle-') ? 'Part of vehicle group' : 'Maintenance task'}
                    </div>
                  </div>
                  <span class="badge bg-${statusClass}">${task.details.status}</span>
                </div>
                
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <div class="small text-muted">Start Date</div>
                    <div class="fw-semibold">${task.start}</div>
                  </div>
                  <div class="col-6">
                    <div class="small text-muted">End Date</div>
                    <div class="fw-semibold">${task.end}</div>
                  </div>
                </div>
                
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <div class="small text-muted">Urgency</div>
                    <span class="badge bg-${urgencyClass}">${task.details.urgency.charAt(0).toUpperCase() + task.details.urgency.slice(1)}</span>
                    ${task.custom_class.includes('overdue') ? '<span class="badge bg-danger ms-1">Overdue</span>' : ''}
                  </div>
                  <div class="col-6">
                    <div class="small text-muted">Technician</div>
                    <div class="fw-semibold">${task.details.technician}</div>
                  </div>
                </div>
                
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <div class="small text-muted">Mileage</div>
                    <div class="fw-semibold">${task.details.mileage}</div>
                  </div>
                  <div class="col-6">
                    <div class="small text-muted">Cost</div>
                    <div class="fw-semibold">${task.details.cost > 0 ? '$' + task.details.cost : 'No cost'}</div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <div class="small text-muted">Progress</div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-${statusClass}" style="width: ${task.progress}%"></div>
                  </div>
                  <div class="small text-end mt-1">${task.progress}%</div>
                </div>
                
                ${task.details.notes ? `
                  <div class="mb-3">
                    <div class="small text-muted">Notes</div>
                    <div class="small">${task.details.notes}</div>
                  </div>
                ` : ''}
                
                <div class="mt-3 pt-3 border-top">
                  <a href="/vehicles/${task.id.split('-')[0]}/maintenances/${task.id}" 
                     class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-eye me-1"></i> View Full Details
                  </a>
                </div>
              </div>
            `;
          }
          
          return `<div class="gantt-popup p-3">${task.name}</div>`;
        },
        on_click: function(task) {
          console.log("Task clicked:", task);
        },
        on_date_change: function(task, start, end) {
          console.log("Date changed:", task, start, end);
        },
        on_progress_change: function(task, progress) {
          console.log("Progress changed:", task, progress);
        },
        on_view_change: function(mode) {
          console.log("View mode changed to:", mode);
        }
      });
      
      // Apply custom classes to rows
      setTimeout(() => {
        document.querySelectorAll('.gantt .grid-row').forEach((row, index) => {
          if (tasks[index]) {
            tasks[index].custom_class.split(' ').forEach(className => {
              if (className) {
                row.classList.add(className);
              }
            });
          }
        });
      }, 100);
      
      // Zoom controls
      document.getElementById('zoomIn').addEventListener('click', function() {
        gantt.change_view_mode(gantt.view_mode === 'Day' ? 'Day' : 
                              gantt.view_mode === 'Week' ? 'Day' : 
                              gantt.view_mode === 'Month' ? 'Week' : 'Month');
      });
      
      document.getElementById('zoomOut').addEventListener('click', function() {
        gantt.change_view_mode(gantt.view_mode === 'Day' ? 'Week' : 
                              gantt.view_mode === 'Week' ? 'Month' : 
                              gantt.view_mode === 'Month' ? 'Quarter' : 'Quarter');
      });
      
      document.getElementById('fitChart').addEventListener('click', function() {
        gantt.refresh(tasks);
      });
      
      // Export chart
      document.getElementById('exportChart').addEventListener('click', function() {
        const svg = document.querySelector('#ganttChart svg');
        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(svg);
        const preface = '<?xml version="1.0" standalone="no"?>\r\n';
        const svgBlob = new Blob([preface, source], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'maintenance-gantt-' + new Date().toISOString().split('T')[0] + '.svg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      
      // View mode selector
      document.getElementById('viewMode').addEventListener('change', function() {
        gantt.change_view_mode(this.value);
      });
    <% end %>
  });
</script>