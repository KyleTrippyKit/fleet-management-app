<% content_for :gantt_page, true %>

<div class="container-fluid py-4">
  <!-- Debug Info -->
  <% if Rails.env.development? %>
    <div class="alert alert-info mb-4">
      <h5 class="alert-heading">Gantt Chart Status</h5>
      <p><strong>Maintenances found:</strong> <%= @maintenances.count %></p>
      <p><strong>Gantt tasks:</strong> <%= @gantt_tasks&.count || 0 %></p>
      <p><strong>Data available:</strong> <%= @gantt_json.present? %></p>
    </div>
  <% end %>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Maintenance Schedule Gantt Chart</h1>
      <p class="text-muted mb-0">Interactive timeline with drag-and-drop scheduling</p>
    </div>
    <div>
      <%= link_to "Maintenance Dashboard", maintenance_dashboard_vehicles_path, 
            class: "btn btn-outline-secondary me-2" %>
      <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), 
            class: "btn btn-primary" if Vehicle.any? %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4 card-hover">
    <div class="card-body p-3">
      <%= form_with url: gantt_path, method: :get, local: true, class: "row g-2 align-items-center", id: "ganttFilters" do %>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">View Mode</label>
          <select name="view_mode" id="viewMode" class="form-select form-select-sm auto-submit">
            <option value="day" <%= 'selected' if params[:view_mode] == 'day' %>>Day View</option>
            <option value="week" <%= 'selected' if params[:view_mode] == 'week' %>>Week View</option>
            <option value="month" <%= params[:view_mode].blank? || params[:view_mode] == 'month' ? 'selected' : '' %>>Month View</option>
            <option value="quarter" <%= 'selected' if params[:view_mode] == 'quarter' %>>Quarter View</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Date Range</label>
          <select name="date_range" id="dateRange" class="form-select form-select-sm auto-submit">
            <option value="all_time" <%= 'selected' if params[:date_range] == 'all_time' %>>All Time</option>
            
            <optgroup label="Past">
              <option value="last_7_days" <%= 'selected' if params[:date_range] == 'last_7_days' %>>Last 7 Days</option>
              <option value="last_30_days" <%= 'selected' if params[:date_range] == 'last_30_days' %>>Last 30 Days</option>
              <option value="last_3_months" <%= 'selected' if params[:date_range] == 'last_3_months' %>>Last 3 Months</option>
              <option value="last_6_months" <%= 'selected' if params[:date_range] == 'last_6_months' %>>Last 6 Months</option>
              <option value="last_year" <%= 'selected' if params[:date_range] == 'last_year' %>>Last Year</option>
            </optgroup>
            
            <optgroup label="Future">
              <option value="next_7_days" <%= 'selected' if params[:date_range] == 'next_7_days' %>>Next 7 Days</option>
              <option value="next_30_days" <%= 'selected' if params[:date_range] == 'next_30_days' || params[:date_range] == '30' %>>Next 30 Days</option>
              <option value="next_3_months" <%= 'selected' if params[:date_range] == 'next_3_months' || params[:date_range] == '90' %>>Next 3 Months</option>
              <option value="next_6_months" <%= 'selected' if params[:date_range] == 'next_6_months' || params[:date_range] == '180' %>>Next 6 Months</option>
              <option value="next_year" <%= 'selected' if params[:date_range] == 'next_year' || params[:date_range] == '365' %>>Next Year</option>
            </optgroup>
            
            <option value="custom" <%= 'selected' if params[:date_range] == 'custom' %>>Custom Range</option>
          </select>
        </div>
        
        <div class="col-md-3" id="customDateRange" style="display: <%= params[:date_range] == 'custom' ? 'block' : 'none' %>;">
          <div class="row g-1">
            <div class="col-6">
              <label class="form-label small fw-bold mb-1">Start Date</label>
              <input type="date" name="start_date" class="form-control form-control-sm auto-submit-date" 
                     value="<%= params[:start_date] || Date.today.strftime('%Y-%m-%d') %>">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold mb-1">End Date</label>
              <input type="date" name="end_date" class="form-control form-control-sm auto-submit-date" 
                     value="<%= params[:end_date] || (Date.today + 90.days).strftime('%Y-%m-%d') %>">
            </div>
          </div>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Service Owner</label>
          <%= select_tag :owner,
                options_for_select(["All Owners"] + @service_owners, params[:owner] || "All"),
                class: "form-select form-select-sm auto-submit" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Status</label>
          <%= select_tag :status,
                options_for_select(["All Statuses", "Pending", "Completed"], params[:status] || "All"),
                class: "form-select form-select-sm auto-submit" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Vehicle Search</label>
          <div class="input-group input-group-sm">
            <%= text_field_tag :vehicle_search, params[:vehicle_search], 
                  class: "form-control auto-submit-vehicle",
                  placeholder: "Search by reg, make, model...",
                  id: "vehicleSearch" %>
            <button class="btn btn-outline-secondary" type="button" id="clearVehicleSearch" title="Clear search">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Specific Vehicle</label>
          <%= select_tag :vehicle_id,
                options_for_select([["All Vehicles", ""]] + @vehicles_for_filter.map { |v| ["#{v.make} #{v.model} (#{v.registration_number})", v.id] }, 
                                  params[:vehicle_id] || ""),
                class: "form-select form-select-sm auto-submit",
                id: "vehicleSelect" %>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2 w-100">
            <%= submit_tag "Apply Filters", class: "btn btn-primary btn-sm flex-grow-1", id: "applyFilters" %>
            <button type="button" id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset</button>
          </div>
        </div>
        
        <!-- Hidden fields to preserve vehicle_id when using search -->
        <%= hidden_field_tag :vehicle_id, params[:vehicle_id] if params[:vehicle_id].present? %>
      <% end %>
    </div>
  </div>

  <!-- Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-tools text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.count %></h3>
              <p class="text-muted mb-0 small">Total Tasks</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
              <i class="bi bi-clock text-warning fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Pending").count %></h3>
              <p class="text-muted mb-0 small">Pending</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3">
              <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.select { |m| m.overdue? }.count %></h3>
              <p class="text-muted mb-0 small">Overdue</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Completed").count %></h3>
              <p class="text-muted mb-0 small">Completed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if @gantt_tasks&.any? %>
    <!-- Store data for JavaScript -->
    <div id="ganttData" style="display: none;" data-gantt-tasks='<%= @gantt_json %>'></div>

    <!-- Gantt Container -->
    <div class="card shadow-sm border-0">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Gantt Chart</h5>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="if (window.gantt) gantt.fitContent();">
            <i class="bi bi-zoom-in"></i> Fit Content
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="ganttContainer" style="width: 100%; height: 600px;"></div>
      </div>
    </div>

    <!-- SIMPLIFIED Gantt JavaScript - No Chart.js dependencies -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Starting Gantt initialization...');
        
        // Function to check if Gantt is loaded
        function checkGanttLoaded() {
          if (typeof gantt !== 'undefined') {
            console.log('‚úÖ DHTMLX Gantt is loaded');
            initializeGantt();
            return true;
          }
          return false;
        }
        
        // Try immediately
        if (!checkGanttLoaded()) {
          console.log('‚è≥ Gantt not loaded yet, waiting...');
          // Try every 500ms for 5 seconds
          let attempts = 0;
          const maxAttempts = 10;
          const interval = setInterval(function() {
            attempts++;
            if (checkGanttLoaded()) {
              clearInterval(interval);
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              console.error('‚ùå Failed to load Gantt after', maxAttempts * 500, 'ms');
              showError('Failed to load Gantt chart library. Please refresh the page.');
            }
          }, 500);
        }
        
        // Initialize auto-submit functionality
        initializeAutoSubmit();
      });
      
      function initializeGantt() {
        // Get data
        const dataElement = document.getElementById('ganttData');
        if (!dataElement) {
          console.error('‚ùå No Gantt data element found');
          showError('No data available');
          return;
        }
        
        const rawData = dataElement.dataset.ganttTasks;
        if (!rawData) {
          console.error('‚ùå No Gantt data found');
          showError('No data available');
          return;
        }
        
        try {
          const parsedData = JSON.parse(rawData);
          console.log('‚úÖ Data parsed successfully, tasks:', parsedData.data?.length || 0);
          
          // Basic Gantt configuration
          gantt.config.date_format = "%Y-%m-%d %H:%i";
          gantt.config.scale_height = 50;
          gantt.config.row_height = 35;
          gantt.config.bar_height = 20;
          gantt.config.grid_width = 300;
          
          // Simple columns
          gantt.config.columns = [
            { name: "text", label: "Task", width: 250, tree: true },
            { name: "start_date", label: "Start", align: "center", width: 100 },
            { name: "end_date", label: "End", align: "center", width: 100 },
            { 
              name: "status", 
              label: "Status", 
              align: "center", 
              width: 100, 
              template: function(task) {
                const status = task.details?.status || task.status || 'Pending';
                let badgeClass = "badge bg-secondary";
                if (status === "Completed") badgeClass = "badge bg-success";
                if (status === "Pending") badgeClass = "badge bg-warning";
                return `<span class="${badgeClass}">${status}</span>`;
              }
            }
          ];
          
          // Time scale
          gantt.config.scales = [
            { unit: "month", step: 1, format: "%F %Y" },
            { unit: "week", step: 1, format: "Week #%W" }
          ];
          
          // Simple tooltip
          gantt.templates.tooltip_text = function(start, end, task) {
            return `<b>${task.text}</b><br/>
                    <b>Dates:</b> ${gantt.templates.tooltip_date_format(start)} - ${gantt.templates.tooltip_date_format(end)}`;
          };
          
          // Initialize and parse
          gantt.init("ganttContainer");
          gantt.parse(parsedData);
          
          console.log('‚úÖ Gantt chart loaded successfully!');
          
        } catch (error) {
          console.error('‚ùå Error loading Gantt chart:', error);
          showError('Error loading chart: ' + error.message);
        }
      }
      
      function showError(message) {
        const container = document.getElementById('ganttContainer');
        if (container) {
          container.innerHTML = `
            <div class="alert alert-danger m-4">
              <h4>Error Loading Gantt Chart</h4>
              <p>${message}</p>
              <p>Please refresh the page or check the console for details.</p>
            </div>
          `;
        }
      }
      
      function initializeAutoSubmit() {
        const form = document.getElementById('ganttFilters');
        if (!form) return;
        
        // Debounce function to prevent too many submissions
        let debounceTimer;
        function debounceSubmit(delay = 300) {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            // Clear vehicle_id if vehicle_search is used
            const vehicleSearch = document.getElementById('vehicleSearch');
            const vehicleSelect = document.getElementById('vehicleSelect');
            if (vehicleSearch && vehicleSearch.value.trim() !== '') {
              vehicleSelect.value = '';
            }
            form.submit();
          }, delay);
        }
        
        // Auto-submit for dropdowns
        const autoSubmitElements = document.querySelectorAll('.auto-submit');
        autoSubmitElements.forEach(element => {
          element.addEventListener('change', function() {
            debounceSubmit(100); // Shorter delay for dropdowns
          });
        });
        
        // Auto-submit for date inputs
        const autoSubmitDateElements = document.querySelectorAll('.auto-submit-date');
        autoSubmitDateElements.forEach(element => {
          element.addEventListener('change', function() {
            debounceSubmit(300); // Standard delay for dates
          });
        });
        
        // Auto-submit for vehicle search with Enter key
        const vehicleSearch = document.getElementById('vehicleSearch');
        if (vehicleSearch) {
          vehicleSearch.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
              // Clear vehicle select when using search
              const vehicleSelect = document.getElementById('vehicleSelect');
              if (vehicleSelect) vehicleSelect.value = '';
              debounceSubmit(100);
            } else if (this.value.trim() === '') {
              // Submit when cleared
              debounceSubmit(500);
            }
          });
          
          // Also submit on blur if value changed
          vehicleSearch.addEventListener('blur', function() {
            if (this.dataset.originalValue !== this.value) {
              const vehicleSelect = document.getElementById('vehicleSelect');
              if (vehicleSelect) vehicleSelect.value = '';
              debounceSubmit(300);
            }
          });
          
          // Store original value
          vehicleSearch.dataset.originalValue = vehicleSearch.value;
        }
        
        // Clear vehicle search button
        const clearVehicleSearch = document.getElementById('clearVehicleSearch');
        if (clearVehicleSearch) {
          clearVehicleSearch.addEventListener('click', function() {
            const vehicleSearch = document.getElementById('vehicleSearch');
            if (vehicleSearch) {
              vehicleSearch.value = '';
              // Clear vehicle select when clearing search
              const vehicleSelect = document.getElementById('vehicleSelect');
              if (vehicleSelect) vehicleSelect.value = '';
              form.submit();
            }
          });
        }
        
        // Filter form toggle
        const dateRange = document.getElementById('dateRange');
        if (dateRange) {
          dateRange.addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
              customRange.style.display = 'block';
            } else {
              customRange.style.display = 'none';
              // Submit when changing from custom to another option
              debounceSubmit(100);
            }
          });
        }
        
        // Reset filters
        const resetFilters = document.getElementById('resetFilters');
        if (resetFilters) {
          resetFilters.addEventListener('click', function() {
            window.location.href = '<%= gantt_path %>';
          });
        }
        
        // Hide Apply Filters button (optional, you can keep it for manual submission)
        // document.getElementById('applyFilters').style.display = 'none';
      }
    </script>
    
  <% else %>
    <!-- No data message -->
    <div class="card shadow-sm border-0">
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="mb-3">No maintenance scheduled</h4>
        <p class="text-muted mb-4">No maintenance records found with valid dates.</p>
        
        <div class="d-flex justify-content-center gap-3 mt-4">
          <%= link_to "View All Vehicles", vehicles_path, class: "btn btn-primary" %>
          <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), 
                class: "btn btn-success" if Vehicle.any? %>
        </div>
      </div>
    </div>
  <% end %>
</div>