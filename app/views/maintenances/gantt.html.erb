<%# app/views/maintenances/gantt.html.erb %>
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Maintenance Schedule Gantt Chart</h1>
      <p class="text-muted mb-0">Visual timeline of all vehicle maintenance tasks</p>
    </div>
    <div>
      <%= link_to "Maintenance Dashboard", maintenance_dashboard_vehicles_path, class: "btn btn-outline-secondary me-2" %>
      <%= link_to "Add Maintenance", new_vehicle_maintenance_path(Vehicle.first), class: "btn btn-primary" if Vehicle.any? %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body p-3">
      <%= form_with url: gantt_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">View Mode</label>
          <select name="view_mode" id="viewMode" class="form-select form-select-sm">
            <option value="Day">Day View</option>
            <option value="Week">Week View</option>
            <option value="Month" selected>Month View</option>
            <option value="Quarter">Quarter View</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Date Range</label>
          <select name="date_range" id="dateRange" class="form-select form-select-sm">
            <option value="30">Next 30 Days</option>
            <option value="90" selected>Next 90 Days</option>
            <option value="180">Next 6 Months</option>
            <option value="365">Next Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        
        <div class="col-md-2" id="customDateRange" style="display: none;">
          <div class="row g-1">
            <div class="col-6">
              <input type="date" name="start_date" class="form-control form-control-sm" value="<%= Date.today.strftime('%Y-%m-%d') %>">
            </div>
            <div class="col-6">
              <input type="date" name="end_date" class="form-control form-control-sm" value="<%= (Date.today + 90.days).strftime('%Y-%m-%d') %>">
            </div>
          </div>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Service Owner</label>
          <%= select_tag :owner,
                options_for_select(["All Owners"] + @service_owners, params[:owner] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Status</label>
          <%= select_tag :status,
                options_for_select(["All Statuses", "Pending", "Completed", "Overdue"], params[:status] || "All"),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Vehicle</label>
          <%= select_tag :vehicle_id,
                options_for_select([["All Vehicles", ""]] + @vehicles_for_filter.map { |v| ["#{v.make} #{v.model} (#{v.registration_number})", v.id] }, 
                                  params[:vehicle_id] || ""),
                class: "form-select form-select-sm" %>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2 w-100">
            <%= submit_tag "Apply Filters", class: "btn btn-primary btn-sm flex-grow-1" %>
            <button type="button" id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset</button>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-tools text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.count %></h3>
              <p class="text-muted mb-0 small">Total Tasks</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
              <i class="bi bi-clock text-warning fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Pending").count %></h3>
              <p class="text-muted mb-0 small">Pending</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3">
              <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.select { |m| m.overdue? }.count %></h3>
              <p class="text-muted mb-0 small">Overdue</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0"><%= @maintenances.where(status: "Completed").count %></h3>
              <p class="text-muted mb-0 small">Completed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gantt Chart Container -->
  <% if @gantt_tasks&.any? %>
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Maintenance Timeline</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" id="zoomIn">
              <i class="bi bi-zoom-in"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="zoomOut">
              <i class="bi bi-zoom-out"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="fitChart">
              <i class="bi bi-fullscreen"></i> Fit to Screen
            </button>
            <button type="button" class="btn btn-outline-primary" id="exportChart">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="ganttChart" style="height: 700px; overflow-x: auto;"></div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body py-2">
        <div class="d-flex align-items-center">
          <span class="me-3 small fw-bold">Legend:</span>
          <div class="d-flex flex-wrap gap-3">
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-success me-2"></span>
              <span class="small">Completed</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-warning me-2"></span>
              <span class="small">Pending</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-danger me-2"></span>
              <span class="small">Overdue</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-info me-2"></span>
              <span class="small">Emergency</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="legend-dot bg-primary me-2"></span>
              <span class="small">Routine</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Table -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Maintenance Details</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Vehicle Details</th>
                <th>Task</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Urgency</th>
                <th>Progress</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @processed_maintenances.each do |maintenance| %>
                <tr class="<%= maintenance.overdue? ? 'table-danger' : '' %>">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <% if maintenance.vehicle.image.attached? %>
                          <%= image_tag maintenance.vehicle.image.variant(resize_to_limit: [50, 50]), 
                                class: "rounded-circle", 
                                style: "width: 40px; height: 40px; object-fit: cover;" %>
                        <% else %>
                          <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                               style="width: 40px; height: 40px;">
                            <i class="bi bi-car-front text-muted"></i>
                          </div>
                        <% end %>
                      </div>
                      <div>
                        <div class="fw-semibold"><%= maintenance.vehicle.make %> <%= maintenance.vehicle.model %></div>
                        <div class="small text-muted">
                          <i class="bi bi-upc-scan me-1"></i><%= maintenance.vehicle.registration_number %>
                          <% if maintenance.vehicle.license_plate.present? %>
                            <span class="ms-2"><i class="bi bi-tag me-1"></i><%= maintenance.vehicle.license_plate %></span>
                          <% end %>
                        </div>
                        <div class="small">
                          <span class="badge bg-<%= owner_color(maintenance.vehicle.service_owner) %>">
                            <%= maintenance.vehicle.service_owner %>
                          </span>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="fw-medium"><%= maintenance.service_type || maintenance.assignment_type %></div>
                    <% if maintenance.notes.present? %>
                      <div class="small text-muted text-truncate" style="max-width: 150px;" title="<%= maintenance.notes %>">
                        <i class="bi bi-chat-left-text me-1"></i><%= truncate(maintenance.notes, length: 50) %>
                      </div>
                    <% end %>
                  </td>
                  <td><%= maintenance.start_date&.strftime("%b %d, %Y") %></td>
                  <td><%= maintenance.end_date&.strftime("%b %d, %Y") %></td>
                  <td>
                    <% duration = (maintenance.end_date - maintenance.start_date).to_i + 1 %>
                    <span class="badge bg-light text-dark"><%= duration %> days</span>
                  </td>
                  <td>
                    <span class="badge <%= maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>">
                      <%= maintenance.status %>
                      <% if maintenance.overdue? %>
                        <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                      <% end %>
                    </span>
                  </td>
                  <td>
                    <span class="badge <%= urgency_badge_class(maintenance.urgency) %>">
                      <%= maintenance.urgency&.titleize || "Normal" %>
                    </span>
                  </td>
                  <td>
                    <div class="progress" style="height: 6px; width: 80px;">
                      <div class="progress-bar <%= maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>" 
                           style="width: <%= maintenance.status == 'Completed' ? '100' : '50' %>%">
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-primary", 
                            title: "View Details" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= link_to edit_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                            class: "btn btn-outline-secondary", 
                            title: "Edit" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <% if maintenance.pending? %>
                        <%= button_to mark_completed_vehicle_maintenance_path(maintenance.vehicle, maintenance), 
                              method: :patch,
                              class: "btn btn-outline-success",
                              title: "Mark Completed",
                              form: { class: "d-inline" } do %>
                          <i class="bi bi-check-circle"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <div class="card shadow-sm border-0">
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="mb-3">No maintenance scheduled</h4>
        <p class="text-muted mb-4">No maintenance records found for the selected filters and date range.</p>
        <div class="d-flex justify-content-center gap-3">
          <%= link_to "View All Vehicles", vehicles_path, class: "btn btn-primary" %>
          <%= link_to "Adjust Filters", "javascript:void(0)", onclick: "document.querySelector('form').scrollIntoView({behavior: 'smooth'});", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Gantt Chart Styles -->
<style>
  .gantt-container {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  .gantt .bar {
    rx: 3px;
    ry: 3px;
  }
  
  .gantt .bar-progress {
    rx: 3px;
    ry: 3px;
  }
  
  .gantt .bar-label {
    font-size: 11px;
    font-weight: 500;
    fill: white;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
  }
  
  .legend-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .table th {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    border-bottom-width: 2px;
  }
  
  .progress {
    background-color: #e9ecef;
  }
  
  /* Custom scrollbar for gantt */
  #ganttChart::-webkit-scrollbar {
    height: 8px;
  }
  
  #ganttChart::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #ganttChart::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #ganttChart::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Hierarchical row styles */
  .gantt .grid-row.vehicle-row {
    background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%) !important;
    border-left: 4px solid #0d6efd !important;
    font-weight: 700 !important;
  }
  
  .gantt .grid-row.folder-row {
    background-color: #fff !important;
    border-left: 3px solid #ffc107 !important;
    font-weight: 600 !important;
  }
  
  .gantt .grid-row.maintenance-row {
    background-color: #f8f9fa !important;
    border-left: 2px solid #6c757d !important;
    font-size: 0.9em !important;
  }
  
  /* Bar colors */
  .gantt .bar.folder-emergency { 
    fill: #dc3545 !important; 
    stroke: #dc3545 !important;
  }
  
  .gantt .bar.folder-scheduled { 
    fill: #0dcaf0 !important;
    stroke: #0dcaf0 !important;
  }
  
  .gantt .bar.folder-upcoming { 
    fill: #20c997 !important;
    stroke: #20c997 !important;
  }
  
  .gantt .bar.folder-completed { 
    fill: #6c757d !important;
    stroke: #6c757d !important;
  }
  
  /* Time-based folder colors */
  .gantt .bar.folder-this_week { 
    fill: #dc3545 !important;
    stroke: #dc3545 !important;
  }
  
  .gantt .bar.folder-next_week { 
    fill: #fd7e14 !important;
    stroke: #fd7e14 !important;
  }
  
  .gantt .bar.folder-this_month { 
    fill: #20c997 !important;
    stroke: #20c997 !important;
  }
  
  .gantt .bar.folder-future { 
    fill: #6c757d !important;
    stroke: #6c757d !important;
  }
  
  /* Status-based maintenance colors */
  .gantt .bar.status-completed { 
    fill: #28a745 !important;
    stroke: #28a745 !important;
  }
  
  .gantt .bar.status-pending { 
    fill: #ffc107 !important;
    stroke: #ffc107 !important;
  }
  
  .gantt .bar.status-overdue { 
    fill: #dc3545 !important;
    stroke: #dc3545 !important;
  }
</style>

<!-- Gantt Chart JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show/hide custom date range
    const dateRangeSelect = document.getElementById('dateRange');
    const customDateRange = document.getElementById('customDateRange');
    
    if (dateRangeSelect) {
      dateRangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customDateRange.style.display = 'block';
        } else {
          customDateRange.style.display = 'none';
        }
      });
    }
    
    // Reset filters
    const resetButton = document.getElementById('resetFilters');
    if (resetButton) {
      resetButton.addEventListener('click', function() {
        window.location.href = '<%= gantt_path %>';
      });
    }
    
    <% if @gantt_tasks&.any? %>
      console.log('Raw gantt_json:', '<%= @gantt_json.to_json %>');
      
      try {
        const tasks = JSON.parse('<%= raw escape_javascript(@gantt_json) %>');
        console.log('Parsed tasks:', tasks);
        console.log('Is array?', Array.isArray(tasks));
        console.log('Length:', tasks ? tasks.length : 0);
        
        if (Array.isArray(tasks) && tasks.length > 0) {
          // Simple test - just show the data
          const container = document.getElementById('ganttChart');
          container.innerHTML = `
            <div class="alert alert-success m-3">
              <h5>Gantt Data Loaded Successfully!</h5>
              <p>Total tasks: ${tasks.length}</p>
              <p>First task: ${JSON.stringify(tasks[0])}</p>
              <button class="btn btn-primary" onclick="initGantt()">Initialize Gantt Chart</button>
            </div>
          `;
          
          window.initGantt = function() {
            if (typeof Gantt === 'undefined') {
              alert('Gantt library not loaded');
              return;
            }
            
            try {
              const gantt = new Gantt("#ganttChart", tasks, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter', 'Month', 'Week', 'Day'],
                bar_height: 22,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 16,
                view_mode: 'Month',
                date_format: 'YYYY-MM-DD',
                custom_row_html: function(task) {
                  if (task.type === 'vehicle') {
                    return `
                      <div class="row-content vehicle-row">
                        <div class="d-flex align-items-center w-100">
                          <div class="me-2">
                            <i class="bi bi-car-front-fill" style="color: ${task.color}"></i>
                          </div>
                          <div class="flex-grow-1">
                            <div class="fw-bold">${task.name}</div>
                            <div class="small text-muted">
                              ${task.details.service_owner} • Driver: ${task.details.current_driver}
                            </div>
                          </div>
                          <div class="text-end">
                            <span class="badge bg-primary">${task.details.registration}</span>
                            ${task.details.license_plate ? 
                              `<span class="badge bg-secondary ms-1">${task.details.license_plate}</span>` : ''}
                          </div>
                        </div>
                      </div>
                    `;
                  } else if (task.type === 'folder') {
                    const timeClass = task.custom_class && task.custom_class.includes('this_week') ? 'danger' :
                                    task.custom_class && task.custom_class.includes('next_week') ? 'warning' :
                                    task.custom_class && task.custom_class.includes('this_month') ? 'success' : 'secondary';
                    
                    return `
                      <div class="row-content folder-row">
                        <div class="d-flex align-items-center w-100">
                          <div class="me-2">
                            <i class="bi bi-folder-fill text-${timeClass}"></i>
                          </div>
                          <div class="flex-grow-1">
                            <div>${task.name}</div>
                            <div class="small text-muted">
                              ${task.details ? task.details.count || 0 : 0} maintenance tasks
                            </div>
                          </div>
                          <div class="text-end">
                            <span class="badge bg-${timeClass}">${task.details ? task.details.period || '' : ''}</span>
                          </div>
                        </div>
                      </div>
                    `;
                  } else if (task.type === 'maintenance') {
                    const statusClass = task.details && task.details.status === 'Completed' ? 'success' : 
                                      task.custom_class && task.custom_class.includes('overdue') ? 'danger' : 'warning';
                    const urgencyClass = task.details && task.details.urgency === 'emergency' ? 'danger' :
                                       task.details && task.details.urgency === 'scheduled' ? 'info' : 'primary';
                    
                    return `
                      <div class="row-content maintenance-row">
                        <div class="d-flex align-items-center w-100">
                          <div class="me-2">
                            <i class="bi bi-tools text-${statusClass}"></i>
                          </div>
                          <div class="flex-grow-1">
                            <div>${task.name}</div>
                            <div class="small text-muted">
                              ${task.details ? (task.details.technician || 'Unassigned') : 'Unassigned'} • 
                              ${task.details ? (task.details.status || 'Pending') : 'Pending'} • 
                              ${task.details && task.details.cost > 0 ? '$' + task.details.cost : 'No cost'}
                            </div>
                          </div>
                          <div class="text-end">
                            <span class="badge bg-${urgencyClass} me-1">
                              ${task.details && task.details.urgency ? 
                                task.details.urgency.charAt(0).toUpperCase() + task.details.urgency.slice(1) : 
                                'Normal'}
                            </span>
                            <span class="badge bg-${statusClass}">
                              ${task.details ? task.details.status : 'Pending'}
                            </span>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                  return `<div class="row-content">${task.name || 'Task'}</div>`;
                }
              });
              
              // Add custom classes for hierarchical styling
              setTimeout(() => {
                document.querySelectorAll('.gantt .grid-row').forEach((row, index) => {
                  if (tasks[index]) {
                    const task = tasks[index];
                    
                    // Add type class
                    if (task.type) {
                      row.classList.add(`${task.type}-row`);
                    }
                    
                    // Add color class based on urgency/status
                    if (task.type === 'maintenance') {
                      if (task.details && task.details.status === 'Completed') {
                        row.classList.add('status-completed');
                      } else if (task.details && task.details.urgency === 'emergency') {
                        row.classList.add('folder-emergency');
                      } else if (task.details && task.details.urgency === 'scheduled') {
                        row.classList.add('folder-scheduled');
                      }
                      
                      // Add time period class
                      if (task.start) {
                        const startDate = new Date(task.start);
                        const today = new Date();
                        const diffTime = startDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= 7) {
                          row.classList.add('folder-this_week');
                        } else if (diffDays <= 14) {
                          row.classList.add('folder-next_week');
                        } else if (diffDays <= 30) {
                          row.classList.add('folder-this_month');
                        } else {
                          row.classList.add('folder-future');
                        }
                      }
                    }
                  }
                });
              }, 100);
              
              // Zoom controls
              document.getElementById('zoomIn').addEventListener('click', function() {
                gantt.change_view_mode(gantt.view_mode === 'Day' ? 'Day' : 
                                      gantt.view_mode === 'Week' ? 'Day' : 
                                      gantt.view_mode === 'Month' ? 'Week' : 'Month');
              });
              
              document.getElementById('zoomOut').addEventListener('click', function() {
                gantt.change_view_mode(gantt.view_mode === 'Day' ? 'Week' : 
                                      gantt.view_mode === 'Week' ? 'Month' : 
                                      gantt.view_mode === 'Month' ? 'Quarter' : 'Quarter');
              });
              
              document.getElementById('fitChart').addEventListener('click', function() {
                gantt.refresh(tasks);
              });
              
              // View mode selector
              document.getElementById('viewMode').addEventListener('change', function() {
                gantt.change_view_mode(this.value);
              });
              
              // Export chart
              document.getElementById('exportChart').addEventListener('click', function() {
                try {
                  const svg = document.querySelector('#ganttChart svg');
                  if (!svg) {
                    alert('No chart to export. Please wait for the chart to load.');
                    return;
                  }
                  const serializer = new XMLSerializer();
                  const source = serializer.serializeToString(svg);
                  const preface = '<?xml version="1.0" standalone="no"?>\r\n';
                  const svgBlob = new Blob([preface, source], {type: 'image/svg+xml;charset=utf-8'});
                  const url = URL.createObjectURL(svgBlob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = 'maintenance-gantt-' + new Date().toISOString().split('T')[0] + '.svg';
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                } catch (error) {
                  console.error('Export failed:', error);
                  alert('Export failed. Please try again.');
                }
              });
              
              console.log('Gantt chart initialized successfully');
            } catch (error) {
              console.error('Error initializing Gantt:', error);
              alert('Error initializing Gantt chart: ' + error.message);
            }
          };
        } else {
          console.error('Tasks is not an array or is empty:', tasks);
          document.getElementById('ganttChart').innerHTML = 
            '<div class="alert alert-warning m-3">No valid tasks data found. Tasks is not an array or is empty.</div>';
        }
      } catch (error) {
        console.error('Error parsing JSON:', error);
        document.getElementById('ganttChart').innerHTML = 
          `<div class="alert alert-danger m-3">Error parsing JSON data: ${error.message}</div>`;
      }
    <% else %>
      console.log('No gantt tasks available');
    <% end %>
  });
</script>