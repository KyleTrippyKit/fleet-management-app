<div class="container py-4">
  <h1 class="mb-4">Maintenance Details</h1>

  <div class="row">
    <!-- Left Column: Vehicle Image & Info -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <% if @vehicle.image.attached? %>
            <%= image_tag @vehicle.image, class: "img-fluid rounded mb-3" %>
          <% else %>
            <%= image_tag "placeholders/default.png", class: "img-fluid rounded mb-3" %>
          <% end %>

          <h5 class="card-title"><%= @vehicle.make %> <%= @vehicle.model %></h5>
          <% if @vehicle.license_plate.present? %>
            <p><span class="badge bg-secondary"><%= @vehicle.license_plate %></span></p>
          <% end %>
          <p><strong>Service Owner:</strong> <%= @vehicle.service_owner %></p>
        </div>
      </div>
    </div>

    <!-- Right Column: Maintenance Details in 2-column rows -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3">

            <!-- Row 1 -->
            <div class="col-md-6 border-end">
              <strong>Date:</strong> <%= @maintenance.date %>
            </div>
            <div class="col-md-6">
              <strong>Next Due:</strong> 
              <% if @maintenance.next_due_date %>
                <%= @maintenance.next_due_date %>
                <% if @maintenance.next_due_date < Date.today %>
                  <span class="badge bg-danger">Overdue</span>
                <% elsif @maintenance.next_due_date <= Date.today + 30 %>
                  <span class="badge bg-warning text-dark">Soon</span>
                <% else %>
                  <span class="badge bg-success">OK</span>
                <% end %>
              <% else %>
                <span class="badge bg-secondary">N/A</span>
              <% end %>
            </div>

            <!-- Row 2 -->
            <div class="col-md-6 border-end">
              <strong>Type:</strong> <%= @maintenance.service_type %>
            </div>
            <div class="col-md-6">
              <strong>Status:</strong> 
              <% if @maintenance.status == "Completed" %>
                <span class="badge bg-success"><%= @maintenance.status %></span>
              <% else %>
                <span class="badge bg-warning text-dark"><%= @maintenance.status %></span>
              <% end %>
            </div>

            <!-- Row 3 -->
            <div class="col-md-6 border-end">
              <strong>Mileage:</strong> <%= @maintenance.mileage || "-" %> km
            </div>
            <div class="col-md-6">
              <strong>Urgency:</strong> 
              <% if @maintenance.urgency_label.present? %>
                <% if @maintenance.urgency_label == "Fast" %>
                  <span class="badge bg-danger"><%= @maintenance.urgency_label %></span>
                <% else %>
                  <span class="badge bg-warning text-dark"><%= @maintenance.urgency_label %></span>
                <% end %>
              <% else %>
                <span class="badge bg-secondary">N/A</span>
              <% end %>
            </div>

            <!-- Row 4 -->
            <div class="col-md-6 border-end">
              <strong>Cost:</strong> <%= @maintenance.cost.present? ? number_to_currency(@maintenance.cost) : "-" %>
            </div>
            <div class="col-md-6">
              <strong>Service Provider:</strong> <%= @maintenance.service_provider&.name || "Not assigned" %>
            </div>

            <!-- Row 5: Full-width Notes -->
            <div class="col-12">
              <strong>Notes:</strong>
              <p class="border rounded p-2 bg-light"><%= @maintenance.notes.presence || "-" %></p>
            </div>

          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-3">
            <%= link_to "Edit", edit_vehicle_maintenance_path(@vehicle, @maintenance), class: "btn btn-warning" %>
            <%= link_to "Back to Vehicle", vehicle_path(@vehicle), class: "btn btn-secondary" %>
          </div>
        </div>
      </div>

      <!-- Timeline / Previous Maintenances -->
      <% previous_records = @vehicle.maintenances.where.not(id: @maintenance.id).order(date: :desc) %>
      <% if previous_records.any? %>
        <h3 class="mt-5 mb-3">Maintenance History</h3>
        <div class="timeline-stepper">
          <% previous_records.each do |m| %>
            <div class="timeline-step">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between">
                  <div><strong><%= m.date %>:</strong> <%= m.service_type %></div>
                  <div>
                    <% if m.status == "Completed" %>
                      <span class="badge bg-success"><%= m.status %></span>
                    <% else %>
                      <span class="badge bg-warning text-dark"><%= m.status %></span>
                    <% end %>
                    <%= link_to "View", vehicle_maintenance_path(@vehicle, m), class: "btn btn-sm btn-outline-primary ms-2" %>
                  </div>
                </div>
                <div class="mt-1">
                  <strong>Mileage:</strong> <%= m.mileage || "-" %> km | 
                  <strong>Cost:</strong> <%= m.cost.present? ? number_to_currency(m.cost) : "-" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
/* Vertical border for columns */
.border-end {
  border-right: 1px solid #dee2e6 !important;
  padding-right: 15px;
}

/* Timeline / Vertical Stepper */
.timeline-stepper {
  position: relative;
  margin-left: 20px;
}
.timeline-stepper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 8px;
  width: 4px;
  height: 100%;
  background: #0d6efd;
}
.timeline-step {
  position: relative;
  margin-bottom: 2rem;
  padding-left: 20px;
}
.timeline-dot {
  position: absolute;
  left: -4px;
  top: 0;
  width: 12px;
  height: 12px;
  background-color: #0d6efd;
  border-radius: 50%;
}
.timeline-content {
  background-color: #f8f9fa;
  border-radius: 5px;
  padding: 10px 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
</style>
