<div class="container py-4">
  <div class="row">
    <!-- Left Column: Vehicle Image & Info -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <% if @vehicle.image.attached? %>
            <%= image_tag @vehicle.image, class: "img-fluid rounded mb-3", style: "max-height: 200px; object-fit: cover;" %>
          <% else %>
            <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 200px;">
              <i class="bi bi-car-front text-muted" style="font-size: 4rem;"></i>
            </div>
          <% end %>

          <h5 class="card-title"><%= @vehicle.make %> <%= @vehicle.model %></h5>
          <p class="mb-2">
            <span class="badge bg-secondary"><%= @vehicle.registration_number %></span>
            <% if @vehicle.license_plate.present? %>
              <span class="badge bg-info ms-1"><%= @vehicle.license_plate %></span>
            <% end %>
          </p>
          <p class="mb-2">
            <strong>Service Owner:</strong> 
            <span class="badge bg-<%= owner_color(@vehicle.service_owner) %>"><%= @vehicle.service_owner %></span>
          </p>
          <p class="mb-0"><strong>Current Mileage:</strong> <%= @vehicle.mileage %> km</p>
        </div>
      </div>
      
      <!-- Timeline Progress -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0">Timeline Progress</h6>
        </div>
        <div class="card-body">
          <p><strong>Duration:</strong> <%= @maintenance.duration_days %> days</p>
          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar <%= @maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>" 
                 style="width: <%= @maintenance.progress_percentage %>%">
            </div>
          </div>
          <p class="small text-center mb-0"><%= @maintenance.progress_percentage %>% complete</p>
          
          <% if @maintenance.overdue? %>
            <div class="alert alert-danger mt-3 mb-0 py-2">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Overdue!</strong> This maintenance is past its end date.
            </div>
          <% elsif @maintenance.active? %>
            <div class="alert alert-info mt-3 mb-0 py-2">
              <i class="bi bi-clock me-2"></i>
              <strong>Active</strong> - Currently in progress
            </div>
          <% elsif @maintenance.upcoming? %>
            <div class="alert alert-warning mt-3 mb-0 py-2">
              <i class="bi bi-calendar me-2"></i>
              <strong>Upcoming</strong> - Starts in <%= (@maintenance.start_date - Date.today).to_i %> days
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Right Column: Maintenance Details -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">Maintenance Details</h1>
            <div>
              <%= link_to "View Timeline", gantt_path, class: "btn btn-outline-info btn-sm me-2" %>
              <span class="badge <%= @maintenance.status == 'Completed' ? 'bg-success' : 'bg-warning' %>">
                <%= @maintenance.status %>
              </span>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <div class="row g-3">
            <!-- Row 1: Dates -->
            <div class="col-md-6">
              <strong>Maintenance Date:</strong><br>
              <%= @maintenance.date&.strftime("%d/%m/%Y") || "N/A" %>
            </div>
            <div class="col-md-6">
              <strong>Next Due Date:</strong><br>
              <% if @maintenance.next_due_date %>
                <%= @maintenance.next_due_date.strftime("%d/%m/%Y") %>
                <% days_remaining = (@maintenance.next_due_date - Date.today).to_i %>
                <span class="badge <%= days_remaining < 0 ? 'bg-danger' : days_remaining <= 14 ? 'bg-warning' : 'bg-success' %> ms-1">
                  <%= days_remaining %> days
                </span>
              <% else %>
                <span class="badge bg-secondary">N/A</span>
              <% end %>
            </div>

            <!-- Row 2: Timeline -->
            <div class="col-md-6">
              <strong>Start Date:</strong><br>
              <%= @maintenance.start_date&.strftime("%d/%m/%Y") || "N/A" %>
            </div>
            <div class="col-md-6">
              <strong>End Date:</strong><br>
              <%= @maintenance.end_date&.strftime("%d/%m/%Y") || "N/A" %>
              <% if @maintenance.overdue? %>
                <span class="badge bg-danger ms-1">Overdue</span>
              <% end %>
            </div>

            <!-- Row 3: Service Info -->
            <div class="col-md-6">
              <strong>Service Type:</strong><br>
              <%= @maintenance.service_type || "N/A" %>
            </div>
            <div class="col-md-6">
              <strong>Category:</strong><br>
              <%= @maintenance.category || "N/A" %>
            </div>

            <!-- Row 4: Status & Urgency -->
            <div class="col-md-6">
              <strong>Status:</strong><br>
              <span class="badge <%= @maintenance.status_badge_class %>">
                <%= @maintenance.status %>
              </span>
            </div>
            <div class="col-md-6">
              <strong>Urgency:</strong><br>
              <%= urgency_badge(@maintenance) %>
            </div>

            <!-- Row 5: Mileage & Cost -->
            <div class="col-md-6">
              <strong>Mileage:</strong><br>
              <%= @maintenance.mileage || "-" %> km
            </div>
            <div class="col-md-6">
              <strong>Cost:</strong><br>
              <%= @maintenance.cost.present? ? number_to_currency(@maintenance.cost) : "-" %>
            </div>

            <!-- Row 6: Assignment -->
            <div class="col-md-6">
              <strong>Assignment Type:</strong><br>
              <%= @maintenance.assignment_type || "N/A" %>
            </div>
            <div class="col-md-6">
              <strong>Service Provider:</strong><br>
              <%= @maintenance.service_provider&.name || "Not assigned" %>
            </div>

            <!-- Row 7: Technician & Source -->
            <div class="col-md-6">
              <strong>Technician:</strong><br>
              <%= @maintenance.technician || "N/A" %>
            </div>
            <div class="col-md-6">
              <strong>Source:</strong><br>
              <%= @maintenance.source || "N/A" %>
            </div>

            <!-- Row 8: Part Status -->
            <div class="col-md-6">
              <strong>Part in Stock:</strong><br>
              <span class="badge <%= @maintenance.part_in_stock ? 'bg-success' : 'bg-danger' %>">
                <%= @maintenance.part_in_stock ? 'Yes' : 'No' %>
              </span>
            </div>
            <div class="col-md-6">
              <strong>Estimated Delivery:</strong><br>
              <%= @maintenance.estimated_delivery_date&.strftime("%d/%m/%Y") || "N/A" %>
            </div>

            <!-- Row 9: Reminder -->
            <div class="col-md-12">
              <strong>Reminder Sent:</strong><br>
              <% if @maintenance.reminder_sent_at %>
                <%= @maintenance.reminder_sent_at.strftime("%d/%m/%Y %I:%M %p") %>
                <span class="badge bg-success ms-2">Sent</span>
              <% else %>
                <span class="badge bg-danger">Not Sent</span>
              <% end %>
            </div>

            <!-- Notes Section -->
            <% if @maintenance.notes.present? %>
              <div class="col-12 mt-3">
                <strong>Notes:</strong>
                <div class="border rounded p-3 bg-light mt-1">
                  <%= simple_format(@maintenance.notes) %>
                </div>
              </div>
            <% end %>

            <!-- Details Section -->
            <% if @maintenance.details.present? %>
              <div class="col-12 mt-3">
                <strong>Details:</strong>
                <div class="border rounded p-3 bg-light mt-1">
                  <%= simple_format(@maintenance.details) %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-4">
            <%= link_to edit_vehicle_maintenance_path(@vehicle, @maintenance), class: "btn btn-warning" do %>
              <i class="bi bi-pencil me-2"></i>Edit
            <% end %>
            <% if @maintenance.pending? %>
              <%= button_to mark_completed_vehicle_maintenance_path(@vehicle, @maintenance), 
                    method: :patch, 
                    class: "btn btn-success",
                    data: { confirm: "Mark this maintenance as completed?" } do %>
                <i class="bi bi-check-circle me-2"></i>Mark Completed
              <% end %>
            <% end %>
            <%= link_to vehicle_path(@vehicle), class: "btn btn-outline-secondary ms-auto" do %>
              <i class="bi bi-arrow-left me-2"></i>Back to Vehicle
            <% end %>
          </div>
        </div>
      </div>

      <!-- Maintenance History -->
      <% previous_records = @vehicle.maintenances.where.not(id: @maintenance.id).order(date: :desc).limit(5) %>
      <% if previous_records.any? %>
        <div class="card shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h3 class="h5 mb-0">Recent Maintenance History</h3>
          </div>
          <div class="card-body">
            <div class="timeline-stepper">
              <% previous_records.each do |m| %>
                <div class="timeline-step">
                  <div class="timeline-dot <%= m.status == 'Completed' ? 'bg-success' : 'bg-warning' %>"></div>
                  <div class="timeline-content">
                    <div class="d-flex justify-content-between">
                      <div>
                        <strong><%= m.date&.strftime("%d/%m/%Y") %>:</strong> <%= m.service_type %>
                        <% if m.category.present? %>
                          <span class="badge bg-info ms-2"><%= m.category %></span>
                        <% end %>
                      </div>
                      <div>
                        <span class="badge <%= m.status == 'Completed' ? 'bg-success' : 'bg-warning' %>">
                          <%= m.status %>
                        </span>
                        <%= link_to "View", vehicle_maintenance_path(@vehicle, m), class: "btn btn-sm btn-outline-primary ms-2" %>
                      </div>
                    </div>
                    <div class="mt-1">
                      <small>
                        <strong>Mileage:</strong> <%= m.mileage || "-" %> km | 
                        <strong>Cost:</strong> <%= m.cost.present? ? number_to_currency(m.cost) : "-" %> |
                        <strong>Duration:</strong> <%= m.duration_days %> days
                      </small>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
            <div class="text-center mt-3">
              <%= link_to "View All Maintenance", vehicle_maintenances_path(@vehicle), class: "btn btn-outline-secondary btn-sm" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
/* Timeline / Vertical Stepper */
.timeline-stepper {
  position: relative;
  margin-left: 20px;
}
.timeline-stepper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 8px;
  width: 4px;
  height: 100%;
  background: #dee2e6;
}
.timeline-step {
  position: relative;
  margin-bottom: 1.5rem;
  padding-left: 20px;
}
.timeline-dot {
  position: absolute;
  left: -4px;
  top: 0;
  width: 12px;
  height: 12px;
  background-color: #0d6efd;
  border-radius: 50%;
}
.timeline-content {
  background-color: #f8f9fa;
  border-radius: 5px;
  padding: 10px 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Progress bar */
.progress {
  background-color: #e9ecef;
}

/* Badge spacing */
.badge {
  font-size: 0.85em;
  font-weight: 500;
}

/* Card styling */
.card {
  border: 1px solid rgba(0,0,0,.125);
}
.card-header {
  background-color: rgba(0,0,0,.03);
  border-bottom: 1px solid rgba(0,0,0,.125);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .col-md-6 {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
  }
  .col-md-6:last-child {
    border-bottom: none;
  }
}
</style>