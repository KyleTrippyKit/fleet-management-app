<%= form_with(model: [@vehicle, @maintenance], local: true, html: { multipart: true }) do |f| %>
  <% if @maintenance.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@maintenance.errors.count, "error") %> prevented this maintenance from saving:</h5>
      <ul>
        <% @maintenance.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3">
    <div class="col-md-6">
      <!-- Assignment Type -->
      <div class="mb-3">
        <%= f.label :assignment_type, "Assignment Type", class: "form-label fw-semibold" %>
        <%= f.select :assignment_type,
                     options_for_select(Maintenance::ASSIGNMENT_TYPES.map { |a| [a.titleize, a] }, @maintenance.assignment_type),
                     { prompt: "Select assignment type" },
                     class: "form-select" %>
      </div>

      <!-- Maintenance Dates -->
      <div class="mb-3">
        <%= f.label :date, "Maintenance Date", class: "form-label fw-semibold" %>
        <%= f.text_field :date, class: "form-control datepicker", value: @maintenance.date&.strftime("%d/%m/%Y") %>
      </div>

      <div class="mb-3">
        <%= f.label :next_due_date, "Next Due Date", class: "form-label fw-semibold" %>
        <%= f.text_field :next_due_date, class: "form-control datepicker", value: @maintenance.next_due_date&.strftime("%d/%m/%Y") %>
      </div>

      <div class="mb-3">
        <%= f.label :reminder_sent_at, "Reminder Sent Date", class: "form-label fw-semibold" %>
        <%= f.text_field :reminder_sent_at, class: "form-control datepicker", value: @maintenance.reminder_sent_at&.strftime("%d/%m/%Y") %>
      </div>

      <!-- Service Type -->
      <div class="mb-3">
        <%= f.label :service_type, "Service Type", class: "form-label fw-semibold" %>
        <%= f.select :service_type,
                     options_for_select(["Oil Change", "Brake Service", "Tire Rotation", "Inspection", "Other"], @maintenance.service_type),
                     { prompt: "Select service type" },
                     class: "form-select" %>
      </div>

      <!-- Status -->
      <div class="mb-3">
        <%= f.label :status, "Status", class: "form-label fw-semibold" %>
        <%= f.select :status,
                     options_for_select(Maintenance::STATUSES, @maintenance.status),
                     { prompt: "Select status" },
                     class: "form-select" %>
      </div>

      <!-- Cost & Notes -->
      <div class="mb-3">
        <%= f.label :cost, "Cost", class: "form-label fw-semibold" %>
        <%= f.number_field :cost, class: "form-control", placeholder: "Enter the cost here", step: 0.01 %>
      </div>

      <div class="mb-3">
        <%= f.label :notes, "Notes", class: "form-label fw-semibold" %>
        <%= f.text_area :notes, class: "form-control", placeholder: "Enter any notes here", rows: 3 %>
      </div>

      <!-- Service Provider -->
      <div class="mb-3">
        <%= f.label :service_provider_id, "Service Provider", class: "form-label fw-semibold" %>
        <%= f.collection_select :service_provider_id, @service_providers, :id, :name, { prompt: "Select provider" }, class: "form-select" %>
      </div>

      <!-- Form Actions -->
      <div class="d-flex gap-2">
        <%= f.submit "Save Maintenance", class: "btn btn-primary" %>
        <%= link_to "Cancel", vehicle_path(@vehicle), class: "btn btn-outline-secondary" %>
      </div>
    </div>

    <!-- Vehicle Image Preview -->
    <div class="col-md-6">
      <h5 class="fw-bold">Vehicle Image</h5>
      <div id="image_preview_container" class="d-flex flex-wrap gap-2">
        <% if @vehicle.image.attached? %>
          <%= image_tag @vehicle.image, class: "img-fluid rounded", style: "max-width:100%; height:auto;" %>
        <% else %>
          <%= image_tag "placeholders/default.png", class: "img-fluid rounded", style: "max-width:100%; height:auto;" %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Flatpickr -->
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/flatpickr" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  flatpickr(".datepicker", {
    dateFormat: "d/m/Y",
    allowInput: true
  });
});
</script>
