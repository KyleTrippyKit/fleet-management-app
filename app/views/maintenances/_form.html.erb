<%= form_with(model: [@vehicle, @maintenance], local: true, html: { multipart: true }) do |f| %>
  <% if @maintenance.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@maintenance.errors.count, "error") %> prevented this maintenance from saving:</h5>
      <ul>
        <% @maintenance.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3">
    <div class="col-md-6">
      <!-- Assignment Type -->
      <div class="mb-3">
        <%= f.label :assignment_type, "Assignment Type", class: "form-label fw-semibold" %>
        <%= f.select :assignment_type,
                     options_for_select(Maintenance::ASSIGNMENT_TYPES.map { |a| [a.titleize, a] }, @maintenance.assignment_type),
                     { prompt: "Select assignment type" },
                     class: "form-select" %>
      </div>

      <!-- Urgency with Badge Preview -->
      <div class="mb-3">
        <%= f.label :urgency, "Urgency", class: "form-label fw-semibold" %>
        <div class="d-flex align-items-center gap-2">
          <%= f.select :urgency,
                       options_for_select(Maintenance::URGENCIES.map { |u| [u.titleize, u] }, @maintenance.urgency),
                       { prompt: "Select urgency" },
                       class: "form-select",
                       id: "urgency_select" %>

          <span id="urgency_badge_preview">
            <%= urgency_badge(@maintenance) if @maintenance.urgency.present? %>
          </span>
        </div>
      </div>

      <!-- Maintenance Dates -->
      <div class="mb-3">
        <%= f.label :date, "Maintenance Date", class: "form-label fw-semibold" %>
        <%= f.text_field :date, class: "form-control datepicker", value: @maintenance.date&.strftime("%d/%m/%Y"), autocomplete: "off" %>
      </div>

      <div class="mb-3">
        <%= f.label :next_due_date, "Next Due Date", class: "form-label fw-semibold" %>
        <%= f.text_field :next_due_date, class: "form-control datepicker", value: @maintenance.next_due_date&.strftime("%d/%m/%Y"), autocomplete: "off" %>
      </div>

      <div class="mb-3">
        <%= f.label :reminder_sent_at, "Reminder Sent Date", class: "form-label fw-semibold" %>
        <%= f.text_field :reminder_sent_at, class: "form-control datepicker", value: @maintenance.reminder_sent_at&.strftime("%d/%m/%Y"), autocomplete: "off" %>
      </div>

      <!-- Other Fields -->
      <div class="mb-3">
        <%= f.label :service_type, "Service Type", class: "form-label fw-semibold" %>
        <%= f.select :service_type,
                     options_for_select(["Oil Change", "Brake Service", "Tire Rotation", "Inspection", "Other"], @maintenance.service_type),
                     { prompt: "Select service type" },
                     class: "form-select" %>
      </div>

      <div class="mb-3">
        <%= f.label :status, "Status", class: "form-label fw-semibold" %>
        <%= f.select :status,
                     options_for_select(Maintenance::STATUSES, @maintenance.status),
                     { prompt: "Select status" },
                     class: "form-select" %>
      </div>

      <div class="mb-3">
        <%= f.label :cost, "Cost", class: "form-label fw-semibold" %>
        <%= f.number_field :cost, class: "form-control", placeholder: "Enter the cost here", step: 0.01 %>
      </div>

      <div class="mb-3">
        <%= f.label :notes, "Notes", class: "form-label fw-semibold" %>
        <%= f.text_area :notes, class: "form-control", placeholder: "Enter any notes here", rows: 3 %>
      </div>

      <div class="mb-3">
        <%= f.label :service_provider_id, "Service Provider", class: "form-label fw-semibold" %>
        <%= f.collection_select :service_provider_id, @service_providers, :id, :name, { prompt: "Select provider" }, class: "form-select" %>
      </div>

      <div class="d-flex gap-2">
        <%= f.submit "Save Maintenance", class: "btn btn-primary" %>
        <%= link_to "Cancel", vehicle_path(@vehicle), class: "btn btn-outline-secondary" %>
      </div>
    </div>

    <!-- Vehicle Image Preview -->
    <div class="col-md-6">
      <h5 class="fw-bold">Vehicle Image</h5>
      <div id="image_preview_container" class="d-flex flex-wrap gap-2">
        <% if @vehicle.image.attached? %>
          <%= image_tag @vehicle.image, class: "img-fluid rounded", style: "max-width:100%; height:auto;" %>
        <% else %>
          <%= image_tag "placeholders/default.png", class: "img-fluid rounded", style: "max-width:100%; height:auto;" %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Flatpickr -->
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/flatpickr" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" %>

<script>
document.addEventListener("turbo:load", () => {
  flatpickr(".datepicker", {
    dateFormat: "d/m/Y",
    allowInput: true
  });

  // Update urgency badge dynamically
  const urgencySelect = document.getElementById("urgency_select");
  const badgePreview = document.getElementById("urgency_badge_preview");

  urgencySelect?.addEventListener("change", (e) => {
    const value = e.target.value;
    let label = "";
    let cssClass = "";
    let tooltip = "";

    if (value) {
      switch (value.toLowerCase()) {
        case "emergency":
          label = "Emergency";
          cssClass = "badge bg-danger text-white";
          tooltip = "High urgency";
          break;
        case "scheduled":
          label = "Scheduled";
          cssClass = "badge bg-warning text-dark";
          tooltip = "Scheduled maintenance";
          break;
        case "routine":
          label = "Routine";
          cssClass = "badge bg-primary text-white";
          tooltip = "Routine maintenance";
          break;
        default:
          label = "N/A";
          cssClass = "badge bg-secondary";
          tooltip = "No urgency selected";
      }
      badgePreview.innerHTML = `<span class="${cssClass}" data-bs-toggle="tooltip" title="${tooltip}">${label}</span>`;
      new bootstrap.Tooltip(badgePreview.querySelector('[data-bs-toggle="tooltip"]'));
    } else {
      badgePreview.innerHTML = "";
    }
  });

  // Initialize Bootstrap tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
