<h3 class="mt-4">Maintenance Records</h3>

<% if vehicle.maintenances.any? %>
  <%= link_to "Add Maintenance", new_vehicle_maintenance_path(vehicle), class: "btn btn-primary mb-3" %>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Next Due</th>
          <th>Reminder Sent</th>
          <th>Type</th>
          <th>Status</th>
          <th>Cost</th>
          <th>Notes</th>
          <th>Urgency</th>
          <th>Service Provider</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% vehicle.maintenances.order(date: :desc).each do |m| %>
          <% days_diff = m.next_due_date ? (m.next_due_date - Date.today).to_i : nil %>
          <% row_class = if days_diff && days_diff < 0
                           "table-danger"
                         elsif days_diff && days_diff <= 30
                           "table-warning"
                         else
                           ""
                         end %>

          <tr class="<%= row_class %>">
            <td><%= m.date %></td>
            <td><%= urgency_badge(m) %></td>

            <td>
              <% if m.reminder_sent_at %>
                <%= m.reminder_sent_at.strftime("%b %d, %Y %I:%M %p") %>
                <span class="badge bg-success" data-bs-toggle="tooltip" title="Reminder sent on <%= m.reminder_sent_at.strftime('%b %d, %Y %I:%M %p') %>">Sent</span>
              <% else %>
                <span class="badge bg-danger" data-bs-toggle="tooltip" title="Reminder not sent">Not Sent</span>
              <% end %>
            </td>

            <td><%= m.service_type %></td>
            <td><%= m.status %></td>
            <td><%= m.cost.present? ? number_to_currency(m.cost) : "-" %></td>
            <td><%= m.notes.presence || "-" %></td>
            <td><%= urgency_badge(m) %></td>
            <td><%= m.service_provider&.name || "Not assigned" %></td>

            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu">
                  <li><%= link_to "Show", vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <li><%= link_to "Edit", edit_vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <li><%= link_to "Delete", confirm_delete_vehicle_maintenance_path(vehicle, m), class: "dropdown-item text-danger" %></li>
                </ul>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="alert alert-info">
    No maintenance records yet. <%= link_to "Add one now", new_vehicle_maintenance_path(vehicle), class: "alert-link" %>
  </div>
<% end %>

<script>
  document.addEventListener("turbo:load", () => {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
