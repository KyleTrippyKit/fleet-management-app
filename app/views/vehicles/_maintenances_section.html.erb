<h3 class="mt-4">Maintenance Records</h3>

<% if vehicle.maintenances.any? %>
  <!-- Show 'Add Maintenance' button -->
  <%= link_to "Add Maintenance", new_vehicle_maintenance_path(vehicle), class: "btn btn-primary mb-3" %>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Next Due</th>
          <th>Reminder Sent</th>
          <th>Type</th>
          <th>Status</th>
          <th>Cost</th>
          <th>Notes</th>
          <th>Urgency</th>
          <th>Service Provider</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% vehicle.maintenances.order(date: :desc).each do |m| %>
          <tr>
            <td><%= m.date %></td>

            <!-- Next Due Column with Badge -->
            <td>
              <% if m.next_due_date %>
                <%= m.next_due_date %>
                <% if m.next_due_date < Date.today %>
                  <span class="badge bg-danger">Overdue!</span>
                <% elsif m.next_due_date <= Date.today + 30 %>
                  <span class="badge bg-warning text-dark">Soon</span>
                <% else %>
                  <span class="badge bg-success">OK</span>
                <% end %>
              <% else %>
                <span class="badge bg-secondary">N/A</span>
              <% end %>
            </td>

            <!-- Reminder Sent Column with Badge -->
            <td>
              <% if m.reminder_sent_at %>
                <%= m.reminder_sent_at.strftime("%b %d, %Y %I:%M %p") %>
                <span class="badge bg-success">Sent</span>
              <% else %>
                <span class="badge bg-danger">Not Sent</span>
              <% end %>
            </td>

            <td><%= m.service_type %></td>
            <td><%= m.status %></td>
            <td><%= m.cost.present? ? number_to_currency(m.cost) : "-" %></td>
            <td><%= m.notes.presence || "-" %></td>
            <td>
              <% if m.urgency_label == "Fast" %>
                <span class="badge bg-success">Fast</span>
              <% else %>
                <span class="badge bg-warning">Soon</span>
              <% end %>
            </td>
            <td><%= m.service_provider&.name || "Not assigned" %></td>

            <!-- Actions Dropdown -->
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu">
                  <li><%= link_to "Show", vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <li><%= link_to "Edit", edit_vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                  <!-- Delete now goes to confirmation page -->
                  <li>
                    <%= link_to "Delete", confirm_delete_vehicle_maintenance_path(vehicle, m), 
                      class: "dropdown-item text-danger" %>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

<% else %>
  <div class="alert alert-info">
    No maintenance records yet. <%= link_to "Add one now", new_vehicle_maintenance_path(vehicle), class: "alert-link" %>
  </div>
<% end %>
