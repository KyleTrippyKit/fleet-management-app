<div class="container py-4" data-controller="chart" data-chart-usage-data-value="<%= @chart_data.to_json %>">
  <h1 class="mb-4 text-primary fw-bold">Vehicle Usage Analytics</h1>

  <%# Add this right after the opening container div %>
  <div class="debug-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h3>Debug Chart Data</h3>
    <pre><%= @chart_data.inspect %></pre>
    <p>Chart data length: <%= @chart_data.length %></p>
    <p>JSON data sent to JavaScript: <%= @chart_data.to_json[0..100] %>...</p>
  </div>

  <!-- ============================================================
       Navigation Tabs
       ============================================================ -->
  <ul class="nav nav-tabs mb-4" id="vehiclesTab" role="tablist">
    <li class="nav-item" role="presentation">
      <%= link_to "Vehicle List",
            vehicles_path,
            class: "nav-link #{'active' if current_page?(vehicles_path)}" %>
    </li>

    <li class="nav-item" role="presentation">
      <%= link_to "Usage Analytics",
            vehicle_usages_path,
            class: "nav-link #{'active' if current_page?(vehicle_usages_path)}" %>
    </li>

    <li class="nav-item" role="presentation">
      <%= link_to "Maintenance Gantt Chart",
            gantt_path,
            class: "nav-link #{'active' if current_page?(gantt_path)}" %>
    </li>

    <li class="nav-item" role="presentation">
      <%= link_to "Maintenance",
            maintenance_dashboard_vehicles_path,
            class: "nav-link #{'active' if current_page?(maintenance_dashboard_vehicles_path)}" %>
    </li>

    <li class="nav-item" role="presentation">
      <%= link_to "Drivers",
            drivers_path,
            class: "nav-link #{'active' if controller_name == 'drivers'}" %>
    </li>
  </ul>

  <!-- ============================================================
       Filter Form
       ============================================================ -->
  <%= form_with url: vehicle_usages_path, method: :get, local: true,
        class: "row g-3 align-items-end mb-4 shadow-sm p-3 rounded" do %>

    <div class="col-md-3">
      <%= label_tag :from, "From", class: "form-label fw-semibold" %>
      <%= date_field_tag :from, params[:from] || 30.days.ago.to_date, class: "form-control form-control-sm" %>
    </div>

    <div class="col-md-3">
      <%= label_tag :to, "To", class: "form-label fw-semibold" %>
      <%= date_field_tag :to, params[:to] || Date.today, class: "form-control form-control-sm" %>
    </div>

    <div class="col-md-3">
      <%= label_tag :owner, "Service Owner", class: "form-label fw-semibold" %>
      <%= select_tag :owner,
            options_for_select(["All", "PTSC", "Police", "Fire Service"], params[:owner] || "All"),
            class: "form-select form-select-sm auto-submit-owner" %>
    </div>

    <div class="col-md-3">
      <%= submit_tag "Filter", class: "btn btn-primary btn-sm w-100" %>
    </div>

  <% end %>

  <!-- ============================================================
       Chart Area - IMPROVED CONTAINER
       ============================================================ -->
  <div class="row g-3">
    <div class="col-md-12">
      <div class="card shadow-sm rounded">
        <div class="card-header bg-light">
          <h5 class="mb-0">Vehicle Usage Chart</h5>
        </div>
        <div class="card-body p-0">
          <% if @chart_data.present? %>
            <div class="chart-container" style="height: 500px; padding: 20px;">
              <canvas data-chart-target="canvas"></canvas>
            </div>
          <% else %>
            <div class="alert alert-warning m-3">
              No trip data found for the selected period.
              <%= link_to "Add a trip", new_vehicle_vehicle_usage_path(Vehicle.first), class: "alert-link" if Vehicle.any? %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       Data Table (Optional - shows raw data)
       ============================================================ -->
  <% if @vehicle_usages.present? %>
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h5 class="mb-0">Usage Data</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Vehicle</th>
                    <th>Trips</th>
                    <th>Distance (km)</th>
                    <th>Hours</th>
                    <th>Utilization %</th>
                  </tr>
                </thead>
                <tbody>
                  <% @vehicle_usages.each do |usage| %>
                    <tr>
                      <td><%= usage[:name] %></td>
                      <td><%= usage[:trip_count] %></td>
                      <td><%= number_with_precision(usage[:distance_km], precision: 1) %></td>
                      <td><%= number_with_precision(usage[:hours_plied], precision: 1) %></td>
                      <td><%= number_with_precision(usage[:utilization], precision: 1) %>%</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ============================================================
       Backup Chart (in case Stimulus fails)
       ============================================================ -->
  <% if @chart_data.present? %>
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Usage Data (Table View - Backup)</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Trips</th>
                  <th>Distance (km)</th>
                  <th>Hours</th>
                  <th>Utilization %</th>
                </tr>
              </thead>
              <tbody>
                <% @chart_data.each do |item| %>
                  <tr>
                    <td><%= item[:registration_number] %></td>
                    <td><%= item[:trip_count] %></td>
                    <td><%= number_with_precision(item[:distance_km], precision: 1) %></td>
                    <td><%= number_with_precision(item[:hours_plied], precision: 1) %></td>
                    <td><%= number_with_precision(item[:utilization], precision: 1) %>%</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- ============================================================
     Styles - IMPROVED CHART STYLING
     ============================================================ -->
<style>
  .transition { transition: all 0.3s ease-in-out; }
  .card h6 { font-size: 0.9rem; }
  
  /* Show debug info when needed */
  .debug-info:hover {
    display: block !important;
  }
  
  /* Chart container styling */
  .chart-container {
    position: relative;
    width: 100%;
    min-height: 500px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .chart-container {
      height: 400px !important;
      min-height: 400px;
      padding: 15px !important;
    }
  }
</style>

<!-- ============================================================
     Auto-submit owner filter
     ============================================================ -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".auto-submit-owner").forEach(select => {
      select.addEventListener("change", () => {
        const form = select.closest("form");
        if (form) form.submit();
      });
    });
    
    // Optional: Log chart data to console for debugging
    const chartContainer = document.querySelector('[data-controller="chart"]');
    if (chartContainer) {
      console.log('Chart data attribute:', chartContainer.dataset.chartUsageDataValue);
      try {
        const chartData = JSON.parse(chartContainer.dataset.chartUsageDataValue);
        console.log('Parsed chart data:', chartData);
      } catch (e) {
        console.error('Failed to parse chart data:', e);
      }
    }
  });
</script>