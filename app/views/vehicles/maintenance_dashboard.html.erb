<div class="container py-4">
  <h1 class="mb-4 text-primary fw-bold">Maintenance Dashboard</h1>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="vehiclesTab" role="tablist">
    <li class="nav-item">
      <%= link_to "Vehicle List", vehicles_path, class: "nav-link #{current_page?(vehicles_path) ? 'active' : ''}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Usage Analytics", analytics_vehicles_path, class: "nav-link #{current_page?(analytics_vehicles_path) ? 'active' : ''}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Maintenance Gantt Chart", gantt_path, class: "nav-link #{current_page?(gantt_path) ? 'active' : ''}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Maintenance", maintenance_dashboard_vehicles_path, class: "nav-link #{current_page?(maintenance_dashboard_vehicles_path) ? 'active' : ''}" %>
    </li>
  </ul>

  <!-- Filters & Search -->
  <%= form_with url: maintenance_dashboard_vehicles_path, method: :get, local: true, html: { id: "maintenance_filter_form" }, class: "row g-2 align-items-end mb-4" do |f| %>
    <div class="col-md-4">
      <%= f.text_field :query, value: @query, placeholder: "Search by make, model, or plate...", class: "form-control shadow-sm rounded" %>
    </div>
    <div class="col-md-4">
      <%= f.select :owner, options_for_select(["All", "PTSC", "Police", "Fire Service"], @owner_filter || "All"), {}, { class: "form-select shadow-sm rounded", id: "owner_filter" } %>
    </div>
    <div class="col-md-4 d-flex gap-2">
      <%= f.submit "Filter", class: "btn btn-primary shadow-sm w-50" %>
      <% if @vehicles.any? %>
        <button class="btn btn-success shadow-sm w-50" type="button" data-bs-toggle="modal" data-bs-target="#selectVehicleModal">
          Add Maintenance
        </button>
      <% end %>
    </div>
  <% end %>

  <!-- Vehicle Selection Modal -->
  <div class="modal fade" id="selectVehicleModal" tabindex="-1" aria-labelledby="selectVehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="selectVehicleModalLabel">Select Vehicle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="vehicleSearchInput" class="form-control" placeholder="Search vehicle...">
          </div>
          <%= form_with url: "#", method: :get, local: true, id: "select-vehicle-form" do |f| %>
            <div class="mb-3">
              <%= f.label :vehicle_id, "Select Vehicle" %>
              <%= f.select :vehicle_id, options_from_collection_for_select(@vehicles, :id, :display_name), {}, class: "form-select", id: "vehicleSelect" %>
            </div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="goToAddMaintenanceBtn">Add Maintenance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- In your maintenance_dashboard.html.erb -->
<% if @vehicles.any? %>
    <% sorted_vehicles = @vehicles.sort_by do |v|
        if v.maintenances.any?
          # Use end_date instead of next_due_date, and handle nil values
          v.maintenances.compact.map { |m| m.end_date ? (m.end_date - Date.today).to_i : 9999 }.min
        else
          10000
        end
      end %>

    <% sorted_vehicles.each do |vehicle| %>
      <div class="mb-4 border p-3 rounded shadow-sm">
        <h5 class="fw-bold mb-2">
          <%= vehicle.display_name %>
          <small class="text-muted">Owner: <%= vehicle.service_owner %></small>
        </h5>

        <% if vehicle.maintenances.any? %>
          <% sorted_maintenances = vehicle.maintenances.compact.sort_by { |m| m.end_date ? (m.end_date - Date.today).to_i : 9999 } %>

          <div class="table-responsive">
            <table class="table align-middle table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Reminder Sent</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Cost</th>
                  <th>Notes</th>
                  <th>Urgency</th>
                  <th>Service Provider</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% sorted_maintenances.each do |m| %>
                  <% next if m.nil? %><!-- ADD THIS LINE TO SKIP NIL MAINTENANCES -->
                  
                  <% days_diff = m.end_date ? (m.end_date - Date.today).to_i : nil %>
                  <% row_class = if days_diff && days_diff < 0
                                  "table-danger"
                                elsif days_diff && days_diff <= 14
                                  "table-warning"
                                else
                                  ""
                                end %>

                  <tr class="<%= row_class %>">
                    <td><%= m.date ? m.date.strftime("%d/%m/%Y") : content_tag(:span, "N/A", class: "text-muted") %></td>
                    <td><%= m.start_date ? m.start_date.strftime("%d/%m/%Y") : content_tag(:span, "N/A", class: "text-muted") %></td>
                    <td><%= m.end_date ? m.end_date.strftime("%d/%m/%Y") : content_tag(:span, "N/A", class: "text-muted") %></td>
                    <td>
                      <% if m.reminder_sent_at %>
                        <%= m.reminder_sent_at.strftime("%b %d, %Y %I:%M %p") %>
                        <span class="badge bg-success">Sent</span>
                      <% else %>
                        <span class="badge bg-danger">Not Sent</span>
                      <% end %>
                    </td>
                    <td><%= m.service_type || content_tag(:span, "N/A", class: "text-muted") %></td>
                    <td>
                      <span class="badge <%= m.status == 'Completed' ? 'bg-success' : 'bg-warning text-dark' %>">
                        <%= m.status || "Pending" %>
                      </span>
                    </td>
                    <td><%= m.cost.present? ? number_to_currency(m.cost) : "-" %></td>
                    <td><%= m.notes.presence || "-" %></td>
                    <td><%= urgency_badge(m) %></td>
                    <td><%= m.service_provider&.name || "Not assigned" %></td>
                    <td>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                          Actions
                        </button>
                        <ul class="dropdown-menu">
                          <li><%= link_to "Edit", edit_vehicle_maintenance_path(vehicle, m), class: "dropdown-item" %></li>
                          <% if m.pending? %>
                            <li><%= link_to "Mark Completed", mark_completed_vehicle_maintenance_path(vehicle, m), method: :patch, data: { confirm: "Mark this maintenance as completed?" }, class: "dropdown-item" %></li>
                          <% end %>
                          <li><%= link_to "Delete", vehicle_maintenance_path(vehicle, m), method: :delete, data: { confirm: "Are you sure?" }, class: "dropdown-item text-danger" %></li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-info">
            No maintenance records yet. <%= link_to "Add one now", new_vehicle_maintenance_path(vehicle), class: "alert-link" %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="alert alert-info">
      No vehicles found. <%= link_to "Add a new vehicle", new_vehicle_path, class: "alert-link" %>
    </div>
  <% end %>
</div>

<style>
  .shadow-sm { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .badge { font-size: 0.9em; }
  .table-hover tbody tr:hover { background-color: #f8f9fa; }
  .text-muted { color: #6c757d !important; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const ownerSelect = document.getElementById("owner_filter");
  const filterForm = document.getElementById("maintenance_filter_form");
  if (ownerSelect && filterForm) ownerSelect.addEventListener("change", () => filterForm.submit());

  const searchInput = document.getElementById("vehicleSearchInput");
  const vehicleSelect = document.getElementById("vehicleSelect");
  const goBtn = document.getElementById("goToAddMaintenanceBtn");

  if (searchInput && vehicleSelect) {
    const options = Array.from(vehicleSelect.options).sort((a, b) => a.text.localeCompare(b.text));
    searchInput.addEventListener("input", () => {
      const filter = searchInput.value.toLowerCase();
      let firstMatchIndex = -1;
      options.forEach((option, index) => {
        option.style.display = "none";
        if (option.text.toLowerCase().includes(filter)) {
          option.style.display = "block";
          if (firstMatchIndex === -1) firstMatchIndex = index;
        }
      });
      if (firstMatchIndex !== -1) vehicleSelect.selectedIndex = firstMatchIndex;
    });
  }

  if (goBtn && vehicleSelect) {
    goBtn.addEventListener("click", () => {
      const selectedId = vehicleSelect.value;
      if (selectedId) {
        const urlTemplate = "<%= new_vehicle_maintenance_path('VEHICLE_ID') %>";
        window.location.href = urlTemplate.replace('VEHICLE_ID', selectedId);
      } else {
        alert("Please select a vehicle first.");
      }
    });
  }

  // Initialize Bootstrap tooltips
  const tooltipList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipList.map((el) => new bootstrap.Tooltip(el));
});
</script>