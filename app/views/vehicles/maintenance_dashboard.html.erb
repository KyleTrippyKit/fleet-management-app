<div class="container py-4">
  <h1 class="mb-4 text-primary fw-bold">Maintenance Dashboard</h1>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="vehiclesTab" role="tablist">
    <li class="nav-item">
      <%= link_to "Vehicle List", vehicles_path, class: "nav-link #{'active' if request.path == vehicles_path}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Usage Analytics", vehicle_usage_path, class: "nav-link #{'active' if request.path == vehicle_usage_path || request.path == analytics_vehicles_path}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Maintenance Gantt Chart", gantt_path, class: "nav-link #{'active' if request.path == gantt_path}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Maintenance", maintenance_dashboard_vehicles_path, class: "nav-link #{'active' if request.path == maintenance_dashboard_vehicles_path}" %>
    </li>
  </ul>

  <!-- Filters & Search -->
  <%= form_with url: maintenance_dashboard_vehicles_path, method: :get, local: true, html: { id: "maintenance_filter_form" }, class: "row g-2 align-items-end mb-4" do |f| %>
    <div class="col-md-4">
      <%= f.text_field :query, value: @query, placeholder: "Search by make, model, or plate...", class: "form-control shadow-sm rounded" %>
    </div>

    <div class="col-md-4">
      <%= f.select :owner, options_for_select(["All", "PTSC", "Police", "Fire Service"], @owner_filter || "All"), {}, { class: "form-select shadow-sm rounded", id: "owner_filter" } %>
    </div>

    <div class="col-md-4 d-flex gap-2">
      <%= f.submit "Filter", class: "btn btn-primary shadow-sm w-50" %>
      <% if @vehicles.any? %>
        <button class="btn btn-success shadow-sm w-50" type="button" data-bs-toggle="modal" data-bs-target="#selectVehicleModal">
          Add Maintenance
        </button>
      <% end %>
    </div>
  <% end %>

  <!-- Vehicle Selection Modal -->
  <div class="modal fade" id="selectVehicleModal" tabindex="-1" aria-labelledby="selectVehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="selectVehicleModalLabel">Select Vehicle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Search + Selection form -->
          <div class="mb-3">
            <input type="text" id="vehicleSearchInput" class="form-control" placeholder="Search vehicle...">
          </div>
          <%= form_with url: "#", method: :get, local: true, id: "select-vehicle-form" do |f| %>
            <div class="mb-3">
              <%= f.label :vehicle_id, "Select Vehicle" %>
              <%= f.select :vehicle_id, options_from_collection_for_select(@vehicles, :id, :display_name), {}, class: "form-select", id: "vehicleSelect" %>
            </div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="goToAddMaintenanceBtn">Add Maintenance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vehicle Maintenances -->
  <% if @vehicles.any? %>
    <% @vehicles.each do |vehicle| %>
      <div class="mb-4 border p-3 rounded shadow-sm">
        <h5 class="fw-bold mb-2">
          <%= vehicle.display_name %>
          <small class="text-muted">Owner: <%= vehicle.service_owner %></small>
        </h5>

        <% pending = vehicle.pending_maintenances %>
        <% if pending.any? %>
          <table class="table table-striped table-hover mb-2">
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Mileage</th>
                <th>Type</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% pending.each do |m| %>
                <tr>
                  <td><%= m.date %></td>
                  <td><span class="badge bg-warning text-dark"><%= m.status %></span></td>
                  <td><%= m.mileage %></td>
                  <td><%= m.service_type %></td>
                  <td><%= m.notes %></td>
                  <td>
                    <%= link_to "Edit", edit_vehicle_maintenance_path(vehicle, m), class: "btn btn-sm btn-outline-warning" %>
                    <%= link_to "Delete", vehicle_maintenance_path(vehicle, m), method: :delete, data: { confirm: "Are you sure?" }, class: "btn btn-sm btn-outline-danger" %>
                    <%= link_to "Mark Completed", mark_maintenance_completed_vehicle_path(vehicle, maintenance_id: m.id), method: :patch, class: "btn btn-sm btn-outline-success" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="alert alert-info mb-2">No pending maintenance for this vehicle.</div>
        <% end %>

        <!-- Completed Maintenance Logs -->
        <div>
          <button class="btn btn-outline-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#logs-<%= vehicle.id %>" aria-expanded="false" aria-controls="logs-<%= vehicle.id %>">
            Show Maintenance Logs
          </button>

          <div class="collapse" id="logs-<%= vehicle.id %>">
            <% completed = vehicle.completed_maintenances %>
            <% if completed.any? %>
              <ul class="list-group">
                <% completed.each do |log| %>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= log.date %></strong> - <%= log.service_type %>
                      <p class="mb-0"><%= log.notes %></p>
                    </div>
                    <span class="badge bg-success"><%= log.status %></span>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="alert alert-secondary">No completed maintenance logs for this vehicle.</div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="alert alert-info">No vehicles found. <%= link_to "Add a new vehicle", new_vehicle_path, class: "alert-link" %></div>
  <% end %>
</div>

<style>
  .shadow-sm { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .badge { font-size: 0.9em; }
  .list-group-item p { font-size: 0.9em; margin: 0; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Auto-submit owner filter
  const ownerSelect = document.getElementById("owner_filter");
  const filterForm = document.getElementById("maintenance_filter_form");
  if (ownerSelect && filterForm) {
    ownerSelect.addEventListener("change", () => filterForm.submit());
  }

  // Vehicle search modal logic
  const searchInput = document.getElementById("vehicleSearchInput");
  const vehicleSelect = document.getElementById("vehicleSelect");
  const goBtn = document.getElementById("goToAddMaintenanceBtn");

  if (searchInput && vehicleSelect) {
    const options = Array.from(vehicleSelect.options).sort((a, b) => a.text.localeCompare(b.text));

    searchInput.addEventListener("input", () => {
      const filter = searchInput.value.toLowerCase();
      let firstMatchIndex = -1;

      options.forEach((option, index) => {
        option.style.display = "none";
        if (option.text.toLowerCase().includes(filter)) {
          option.style.display = "block";
          if (firstMatchIndex === -1) firstMatchIndex = index;
        }
      });

      if (firstMatchIndex !== -1) {
        vehicleSelect.selectedIndex = firstMatchIndex;
        vehicleSelect.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    });
  }

  // Redirect to new maintenance for selected vehicle
  if (goBtn && vehicleSelect) {
    goBtn.addEventListener("click", () => {
      const selectedId = vehicleSelect.value;
      if (selectedId) {
        const urlTemplate = "<%= new_vehicle_maintenance_path('VEHICLE_ID') %>";
        window.location.href = urlTemplate.replace('VEHICLE_ID', selectedId);
      } else {
        alert("Please select a vehicle first.");
      }
    });
  }
});
</script>
